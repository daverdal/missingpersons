<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Login - Missing Persons App</title>
    <link rel="stylesheet" href="retro.css">
        <style>
        #dbStatusBox {
            display: none;
            background: #000;
            color: #4aff4a;
            font-family: 'Fira Mono', 'Consolas', monospace;
            font-size: 1.1rem;
            border-radius: 8px;
            border: 2px solid #4aff4a;
            margin: 1.5rem auto 0 auto;
            padding: 1.2rem 1.5rem 1.2rem 1.5rem;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            position: relative;
            z-index: 10;
        }
        #dbStatusBox .blinker {
            animation: blink 1s steps(2, start) infinite;
            color: #4aff4a;
        }
        @keyframes blink {
            to { visibility: hidden; }
        }
        #loginForm[aria-disabled="true"] {
            pointer-events: none;
            opacity: 0.5;
        }
        #loginForm[aria-disabled="true"] button {
            background: #888;
            color: #23272b;
            cursor: not-allowed;
        }
        .login-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 2.5rem auto 0 auto;
            max-width: 480px;
        }
        .login-center h1 {
            text-align: center;
        }
        .login-center form {
            display: flex;
            flex-direction: column;
            gap: 1.1em;
            width: 100%;
        }
        .login-center label {
            display: flex;
            flex-direction: row;
            align-items: center;
            font-size: 1.1em;
            gap: 0.8em;
        }
        .login-center input[type="email"],
        .login-center input[type="password"] {
            flex: 1 1 0;
            font-size: 1em;
            padding: 0.3em 0.5em;
        }
        .login-center button {
            margin-top: 0.7em;
        }
            .login-hint-box {
                margin-top: 1em;
                font-size: 1em;
                background: #000;
                color: #4aff4a;
                padding: 1.2rem 1.5rem;
                border-radius: 8px;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                width: 100%;
                max-width: 600px;
                text-align: center;
                font-family: 'Fira Mono', 'Consolas', monospace;
                border: 2px solid #4aff4a;
            }
        </style>
</head>
<body>
    <header>
    <h1 style="text-align:center;">Case Management</h1>
    <!-- Removed page heading from login.html -->
    <div id="dbStatusBox">
        <span style="font-weight:bold;">Database Connection Error</span><br>
        <span style="font-size:0.98em;">The database is currently unavailable.<br>
        Please try again later or contact support.<br>
        <span class="blinker">â–ˆ</span></span>
    </div>
    <div class="login-center">
        <h1>Staff Login</h1>
        <form id="loginForm" autocomplete="off">
            <label>Email: <input type="email" name="email" required></label>
            <label>Password: <input type="password" name="password" required></label>
            <button type="submit">Login</button>
        </form>
        <div class="login-hint-box">
            <strong>Test Users:</strong><br>
            <b>Admin:</b> admin1@example.com / <b>admin</b><br>
            <b>Case Worker 1:</b> caseworker1@example.com / <b>admin</b><br>
            <b>Case Worker 2:</b> caseworker2@example.com / <b>admin</b><br>
            <b>Case Worker 3:</b> caseworker3@example.com / <b>admin</b><br>
            <b>Staff User 1:</b> user1@example.com / <b>admin</b><br>
        </div>
        <div id="loginMessage"></div>
    </div>
    </main>
        <script>
        async function checkDbHealth() {
            try {
                const res = await fetch('/api/health/db', { cache: 'no-store' });
                if (!res.ok) throw new Error('DB down');
                const data = await res.json();
                if (data.status !== 'ok') throw new Error('DB down');
                return true;
            } catch {
                return false;
            }
        }

        function showDbErrorBox() {
            const box = document.getElementById('dbStatusBox');
            box.style.display = 'block';
            const form = document.getElementById('loginForm');
            form.setAttribute('aria-disabled', 'true');
        }

        function hideDbErrorBox() {
            const box = document.getElementById('dbStatusBox');
            box.style.display = 'none';
            const form = document.getElementById('loginForm');
            form.removeAttribute('aria-disabled');
        }

        async function updateDbStatus() {
            const healthy = await checkDbHealth();
            if (!healthy) {
                showDbErrorBox();
            } else {
                hideDbErrorBox();
            }
        }

        // Initial check and periodic polling
        updateDbStatus();
        setInterval(updateDbStatus, 10000);

        document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                if (document.getElementById('loginForm').getAttribute('aria-disabled') === 'true') {
                    showDbErrorBox();
                    return;
                }
                const form = e.target;
                const email = form.email.value;
                const password = form.password.value;
                const res = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password })
                });
                const result = await res.json();
                if (result.success) {
                        // Store JWT token in a cookie for authentication
                        document.cookie = `token=${result.token}; path=/; SameSite=Lax`;
                        // Also store in localStorage for easy access
                        localStorage.setItem('token', result.token);
                        // Show token in a message before redirecting
                        const messageDiv = document.getElementById('loginMessage');
                        messageDiv.innerHTML = '<div style="background:#000;color:#4aff4a;padding:1rem;border:2px solid #4aff4a;border-radius:8px;margin-top:1rem;font-family:monospace;font-size:0.9em;">' +
                            '<strong>Login successful!</strong><br>' +
                            '<div style="margin-top:0.5rem;word-break:break-all;">JWT Token: ' + result.token + '</div>' +
                            '<button onclick="navigator.clipboard.writeText(\'' + result.token + '\');alert(\'Token copied!\');" ' +
                            'style="margin-top:0.5rem;padding:0.3rem 0.8rem;background:#4aff4a;color:#000;border:none;border-radius:4px;cursor:pointer;font-weight:600;">Copy Token</button>' +
                            '<div style="margin-top:0.5rem;font-size:0.85em;opacity:0.8;">Redirecting in 3 seconds... (or <a href="allcases.html" style="color:#4aff4a;">click here</a>)</div>' +
                            '</div>';
                        messageDiv.style.color = '#4aff4a';
                        setTimeout(() => {
                            window.location.href = 'allcases.html';
                        }, 3000);
                } else {
                        document.getElementById('loginMessage').textContent = result.error || 'Login failed.';
                        document.getElementById('loginMessage').style.color = '#ff7f7f';
                }
        });
        </script>
</body>
</html>
