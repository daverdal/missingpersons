<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Notes - Missing Persons App</title>
    <link rel="stylesheet" href="retro.css">
    <script src="navbar.js"></script>
    <script src="navbar-auth.js"></script>
    <style>
        .note-success-message {
            color: #1b7e3c;
            font-weight: bold;
            font-size: 1em;
            transition: opacity 0.3s;
        }
        .note-success-message.error {
            color: #a05a5a;
        }
        .custom-file-label {
            background: #222 !important;
            color: #6fcf6f !important;
            border: none !important;
            border-radius: 4px !important;
            padding: 0.4em 1.4em !important;
            font-weight: bold !important;
            cursor: pointer;
            font-size: 1em;
            margin-bottom: 0.3em;
            display: inline-block;
            transition: background 0.2s;
        }
        .custom-file-label:hover {
            background: #444 !important;
        }
        .case-detail-row .detail-label {
            color: #aaa;
        }
        .case-detail-row .detail-value {
            color: inherit;
        }
        .loved-one-subtitle {
            font-weight: bold;
            color: #6fcf6f;
            margin-top: 0.6em;
        }
        .loved-one-list {
            list-style: disc;
            padding-left: 1.4em;
            margin: 0.3em 0 0.6em 0;
        }
        .loved-one-list li {
            margin-bottom: 0.25em;
        }
        .loved-one-muted {
            color: #888;
            font-style: italic;
            margin: 0.3em 0 0.6em 0;
        }
        .loved-one-extra {
            color: #e6b85c;
            margin-bottom: 0.6em;
        }
        .loved-one-notes {
            white-space: pre-wrap;
            margin: 0.3em 0 0.6em 0;
        }
    </style>
</head>
<body>
    <header>
        <h1 style="text-align:center;">Missing Persons Case Management</h1>
        <nav>
            <div style="text-align:center;">
                <a href="intake.html" style="margin-right: 2em;">Intake Form</a>
                <a href="mycases.html" id="myCasesLink" style="display:none; margin-right: 2em;">My Cases</a>
                <a href="allcases.html" id="allCasesLink" style="margin-right: 2em;">All Cases</a>
                <a href="admin-clean.html" id="adminLink" style="margin-right: 2em;">Admin Panel</a>
                <a href="login.html" id="loginLink" style="margin-right: 2em;">Login</a>
                <a href="#" id="logoutLink" style="display:none; margin-right: 2em;">Logout</a>
            </div>
        </nav>
    </header>
        <main>
            <!-- Attach Document header removed as requested -->
            <div class="case-flex-row">
                <div id="caseInfo" class="case-details-box">
                    <!-- Case details will be loaded here -->
                </div>
                <div class="upload-box">
                    <form id="uploadFileForm" enctype="multipart/form-data" class="upload-box-form">
                        <input type="file" name="file" id="fileInput" required style="display: none;">
                        <label for="fileInput" id="fileInputLabel" class="custom-file-label" style="background: #222; color: #fff; border: 1px solid #444; border-radius: 4px; padding: 0.2em 0.7em; cursor: pointer; margin-bottom: 0.3em; display: inline-block;">Choose File</label>
                        <span id="selectedFileName" style="min-width: 120px; display: block; margin-top: 0.2em; margin-bottom: 0.5em; word-break: break-all;"></span>
                        <button type="submit">Upload File</button>
                    </form>
                    <div id="uploadError" style="color: red; margin-top: 0.5em;"></div>
                    <div id="filesList" style="background: #000; max-height: 8.5em; overflow-y: auto; border-radius: 6px; padding: 0.5em 0.7em; margin-top: 0.5em;"></div>
                </div>
            </div>
            <hr style="border: none; border-top: 3px solid #444; margin-bottom: 1.2em; margin-top: 2em;">
                    <div style="display: flex; flex-direction: row; align-items: flex-start; gap: 0.5em;">
                        <h1 style="margin: 0 1em 0 0; padding: 0; font-size: 1.5em; line-height: 1.2; white-space: nowrap;">Case Notes</h1>
                        <form id="addNoteForm" class="note-form-vertical" style="margin-bottom: 0; max-width: 1000px; align-items: flex-start; display: flex; flex-direction: row; gap: 1em; justify-content: flex-start;">
                            <textarea name="noteText" placeholder="Add a new note..." required class="wide-note-textarea" style="flex: 2 1 700px; min-width: 400px; max-width: 1000px; margin-left: 0; height: 2.2em; resize: vertical; margin-right: 1em;"></textarea>
                            <button type="submit" class="add-note-btn" style="background: #222; color: #6fcf6f; border: none; border-radius: 4px; padding: 0.4em 1.4em; font-weight: bold; font-size: 1em; cursor: pointer; min-width: 120px; margin-left: 0; margin-right: 1em; transition: background 0.2s;">Add Note</button>
                            <span id="message" class="note-success-message" style="display:inline-block; min-width: 90px; min-height: 1.2em; margin-left: 0.5em; opacity: 0;"></span>
                        </form>
                    </div>
                    <div id="notesList" style="width: 100%; max-width: 900px; margin-top: 1.5em;"></div>
                    <div id="notesList" style="width: 100%; max-width: 900px; margin-top: 1.5em;"></div>
        </main>
        <section style="margin:2em 0;">
            <h2 style="font-size:1.1em;color:#999;">Debug Info (temporary)</h2>
            <pre id="debugInfo" style="background:#111;border:1px solid #333;padding:1em;border-radius:6px;overflow:auto;max-height:280px;font-size:0.85em;"></pre>
        </section>
        <style>
        /* Make file links in the upload area green by default, blue and underlined on hover */
        #filesList a.upload-list-link {
            color: #1b7e3c;
            text-decoration: none;
            font-weight: bold;
            font-size: 1em;
            transition: color 0.2s;
        }
        #filesList a.upload-list-link:hover {
            color: #1976d2;
            text-decoration: underline;
        }
        /* Make file upload links in notes always blue and underlined, darker blue on hover */
        .file-upload-link {
            color: #1976d2 !important;
            text-decoration: underline;
            font-weight: bold;
            font-size: 1em;
            transition: color 0.2s;
        }
        .file-upload-link:hover {
            color: #0d47a1 !important;
        }
        .case-header-flex-row {
            display: flex;
            flex-direction: row;
            align-items: flex-end;
            gap: 2.5em;
            margin-bottom: 0.2em;
        }
        .case-header {
            font-size: 2em;
            font-weight: bold;
            color: #222;
            margin: 0;
            border: none !important;
            outline: none !important;
            background: none !important;
            box-shadow: none !important;
        }
        /* Popup message for note added */
        .popup-message {
            position: fixed;
            left: 50%;
            top: 2.5em;
            transform: translateX(-50%);
            background: #222;
            color: #fff;
            padding: 0.8em 2.2em;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 500;
            box-shadow: 0 2px 16px rgba(0,0,0,0.18);
            opacity: 0;
            pointer-events: none;
            z-index: 9999;
            transition: opacity 0.4s cubic-bezier(.4,0,.2,1);
        }
        .popup-message.show {
            opacity: 1;
            pointer-events: auto;
        }
        .popup-message.error {
            background: #a05a5a;
            color: #fff;
        }
    /* .upload-box-heading removed, now using inline style for h1 to match other headers */
        .upload-box {
            max-width: 520px;
            min-width: 320px;
            width: 100%;
        }
        #filesList {
            max-width: 520px;
            background: #000;
            max-height: 8.5em;
            overflow-y: auto;
            border-radius: 6px;
            padding: 0.5em 0.7em;
        }
        #filesList::-webkit-scrollbar {
            width: 10px;
            background: #222;
        }
        #filesList::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 6px;
        }
        #filesList::-webkit-scrollbar-thumb:hover {
            background: #aaa;
            min-width: 320px;
            width: 100%;
            word-break: break-all;
        }
        .case-flex-row {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 2.5em;
            margin-bottom: 2em;
            justify-content: flex-start;
        }
        .case-details-box {
            flex: 1 1 340px;
            min-width: 300px;
            max-width: 800px;
        }
                    .notes-flex-row {
                        display: flex;
                        flex-direction: row;
                        align-items: flex-start;
                            gap: 1em;
                            margin-bottom: 1em;
                    }
                                                .note-form-vertical {
                                                    display: flex;
                                                    flex-direction: column;
                                                    align-items: stretch;
                            width: 90%;
                            min-width: 234px;
                            max-width: 340px;
                            min-width: 234px;
                            width: 100%;
                            margin-left: auto;
                                                            width: 95%;
                                                            min-width: 210px;
                                                            max-width: 340px;
                                                            min-width: 234px;
                                                            width: 100%;
                                                            word-break: break-word;
                                                            margin-left: auto;
                                                            font-size: 1.1em;
                                                            margin-bottom: 0.5em;
                                                            box-sizing: border-box;
                                                            resize: vertical;
                                                        }
                                        .add-note-btn-row {
                                            display: flex;
                                            flex-direction: row;
                                            justify-content: flex-end;
                                            width: 90%; /* match textarea width */
                                            margin-left: 0;
                                            margin-bottom: 0.2em;
                                        .notes-list {
                                            flex: 1;
                                            min-width: 260px;
                                            max-width: 420px;
                                            margin-left: 16px;
                                            background: #f7f7f7;
                                            border-radius: 8px;
                                            padding: 12px 8px;
                                            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
                                            overflow-y: auto;
                                            max-height: 340px;
                                        }
                                        .note-item {
                                            background: #fff;
                                            border-radius: 6px;
                                            margin-bottom: 16px;
                                            padding: 16px 16px 12px 16px;
                                            box-shadow: 0 1px 3px rgba(0,0,0,0.07);
                                            font-size: 1.18em;
                                            line-height: 1.5;
                                            word-break: break-word;
                                        }
                font-weight: bold;
                color: #6fcf6f;
                margin-bottom: 0.7em;
            }
            .upload-box-form {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5em;
                margin-bottom: 1em;
            }
            .upload-box input[type="file"] {
                color: #fff;
                background: #222;
                border: 1px solid #444;
                border-radius: 4px;
                padding: 0.2em 0.4em;
            }
            .upload-box button {
                background: #222;
                color: #6fcf6f;
                border: none;
                border-radius: 4px;
                padding: 0.4em 1.4em;
                font-weight: bold;
                cursor: pointer;
                transition: background 0.2s;
                min-width: 120px;
                white-space: nowrap;
            }
            .upload-box button:hover {
                background: #444;
            }
            .upload-box ul, .upload-box li, .upload-box a, .upload-box span {
            /* Popup message for note added */
            .popup-message {
                position: fixed;
                left: 50%;
                top: 2.5em;
                transform: translateX(-50%);
                background: #222;
                color: #fff;
                padding: 0.8em 2.2em;
                border-radius: 8px;
                font-size: 1.1em;
                font-weight: 500;
                box-shadow: 0 2px 16px rgba(0,0,0,0.18);
                opacity: 0;
                pointer-events: none;
                z-index: 9999;
                transition: opacity 0.4s cubic-bezier(.4,0,.2,1);
            }
            .popup-message.show {
                opacity: 1;
                pointer-events: auto;
            }
            .popup-message.error {
                background: #a05a5a;
                color: #fff;
            }
                /* color: #fff !important; */
            /* Note: file link color and underline are now set in CSS below for the file list. */
            }


            .upload-box ul {
                margin: 0.5em 0 0 0;
                padding-left: 0;
                list-style-type: none;
            }
        </style>
        <script>
    // Allowed MIME types for client-side validation
    const allowedTypes = [
        'application/pdf',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
        'application/msword',
        'image/jpeg',
        'image/png',
        'image/gif'
    ];

    const SUPPORT_OPTIONS = [
        'Emotional or Cultural Support',
        'Grief Counseling or Mental Health Support',
        'Legal Advocacy or Representation',
        'Help Navigating Police or Justice System',
        'Media or Public Awareness Support',
        'Help Organizing Vigils or Community Events',
        'Financial Assistance or Guidance',
        'Transportation or Housing Support',
        'Translation or Language Services',
        'Youth or Family Support Services',
        'Access to Religious or Spiritual Services',
        'Access to Traditional Healing or Medicine',
        'Ongoing Case Updates or Advocacy',
        'Accommodation'
    ];

    function escapeHtml(value) {
        return String(value ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }

    function escapeAttr(value) {
        return escapeHtml(value).replace(/"/g, '&quot;');
    }

    // Warn user immediately if file type is not allowed
    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const errorDiv = document.getElementById('uploadError');
        const fileNameSpan = document.getElementById('selectedFileName');
        if (file) {
            fileNameSpan.textContent = file.name;
        } else {
            fileNameSpan.textContent = '';
        }
        if (file && !allowedTypes.includes(file.type)) {
            errorDiv.textContent = 'Only PDF, DOCX, DOC, JPG, PNG, and GIF files are allowed.';
            e.target.value = '';
            fileNameSpan.textContent = '';
        } else {
            errorDiv.textContent = '';
        }
    });
    // Fetch and display files for the case
    async function fetchFiles(caseId) {
        const res = await fetch(`/api/cases/${encodeURIComponent(caseId)}/files`, {
            headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        const filesDiv = document.getElementById('filesList');
        // Only update the contents, not the structure/layout
        filesDiv.innerHTML = '';
        if (!res.ok) {
            filesDiv.innerHTML = '<i>No files found or failed to load.</i>';
            return;
        }
        const data = await res.json();
        try {
            const debugBlock = document.getElementById('debugInfo');
            if (debugBlock) {
                debugBlock.textContent = JSON.stringify({
                    applicant: data.applicant,
                    lovedOnes: data.lovedOnes,
                    referringOrg: data.referringOrg
                }, null, 2);
            }
        } catch (e) {
            console.warn('[DEBUG] Failed to render debug info', e);
        }
        if (!data.files || data.files.length === 0) {
            filesDiv.innerHTML = '<i>No files uploaded yet.</i>';
            return;
        }
        // Check if user is admin
        const isAdmin = userIsAdmin();
        // Wrap in a <ul>
        const ul = document.createElement('ul');
        ul.style.listStyleType = 'none';
        ul.style.paddingLeft = '0';
        data.files.forEach(file => {
            const li = document.createElement('li');
            li.style.marginBottom = '6px';
            li.style.listStyleType = 'none';
            const link = document.createElement('a');
            link.href = `/uploads/${file.filename}`;
            link.textContent = file.originalname;
            link.target = '_blank';
            link.className = 'upload-list-link';
            li.appendChild(link);
            if (isAdmin) {
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Delete';
                delBtn.className = 'deleteFileBtn';
                delBtn.setAttribute('data-filename', file.filename);
                delBtn.style.marginLeft = '1em';
                li.appendChild(delBtn);
            }
            ul.appendChild(li);
        });
        filesDiv.appendChild(ul);
        if (isAdmin) {
          // Add delete handlers
          document.querySelectorAll('.deleteFileBtn').forEach(btn => {
              btn.addEventListener('click', async function() {
                  if (!confirm('Delete this file?')) return;
                  const filename = btn.getAttribute('data-filename');
                  const res = await fetch(`/api/cases/${encodeURIComponent(caseId)}/files/${encodeURIComponent(filename)}`, {
                      method: 'DELETE',
                      headers: { 'Authorization': 'Bearer ' + getToken() }
                  });
                  const result = await res.json();
                  document.getElementById('message').textContent = result.success ? 'File deleted!' : (result.error || 'Failed to delete file.');
                  if (result.success) await fetchFiles(caseId);
              });
          });
        }
        // Helper: check if user is admin by decoding JWT
        function userIsAdmin() {
            const token = getToken();
            if (!token) return false;
            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                return Array.isArray(payload.roles) && payload.roles.includes('admin');
            } catch (e) {
                return false;
            }
        }
    }

    // Handle file upload
    document.getElementById('uploadFileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const caseId = getCaseId();
        const form = e.target;
        const fileInput = form.file;
        const errorDiv = document.getElementById('uploadError');
        errorDiv.textContent = '';
        if (!fileInput.files.length) return;
        const file = fileInput.files[0];
        if (!allowedTypes.includes(file.type)) {
            errorDiv.textContent = 'Only PDF, DOCX, DOC, JPG, PNG, and GIF files are allowed.';
            return;
        }
        const formData = new FormData();
        formData.append('file', file);
        try {
            const res = await fetch(`/api/cases/${encodeURIComponent(caseId)}/upload`, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + getToken() },
                body: formData
            });
            const result = await res.json();
            if (!res.ok) {
                errorDiv.textContent = result.error || 'File upload failed.';
            } else {
                form.reset();
                await fetchFiles(caseId);
                await fetchNotes(caseId);
            }
        } catch (err) {
            errorDiv.textContent = 'File upload failed.';
        }
    });
    // Get caseId from query string
    function getCaseId() {
        const params = new URLSearchParams(window.location.search);
        return params.get('caseId');
    }
    function getToken() {
        const match = document.cookie.match(/(^| )token=([^;]+)/);
        if (match) return match[2];
        return localStorage.getItem('token') || sessionStorage.getItem('token') || '';
    }
    function userHasRole(required) {
        const token = getToken();
        if (!token) return false;
        try {
            const payload = JSON.parse(atob(token.split('.')[1]));
            let roles = payload.roles || payload.groups || payload.roles_claim || [];
            if (!Array.isArray(roles)) roles = [roles];
            return required.some(role => roles.includes(role));
        } catch (e) {
            return false;
        }
    }
    async function fetchCaseInfo(caseId) {
        const res = await fetch('/api/applicants/' + encodeURIComponent(caseId), {
            headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        if (!res.ok) return;
        const data = await res.json();
        let html = '<h1>Case Details</h1>';
        // Show all applicant fields except id and internal Neo4j fields, as a simple list
        if (data.applicant) {
            html += '<div style="margin:1em 0 1.5em 0;">';
            // Show status first if it exists, highlighted
            if (data.applicant.status) {
                html += `<div style='margin-bottom:0.5em;'><span style='color:#aaa;'>Status:</span> <span style='font-weight:bold;color:#6fcf6f;'>${escapeHtml(data.applicant.status)}</span></div>`;
            }
            for (const [key, value] of Object.entries(data.applicant)) {
                if (["id", "_id", "_labels", "__v", "smsOptIn", "emailOptIn", "status"].includes(key)) continue;
                html += `<div style='margin-bottom:0.5em;'><span style='color:#aaa;'>${key.replace(/([A-Z])/g, ' $1').replace(/^./, s => s.toUpperCase())}:</span> <span>${value || ''}</span></div>`;
            }
            // Display opt-in statuses in a more readable format
            const smsOptIn = data.applicant.smsOptIn;
            const emailOptIn = data.applicant.emailOptIn;
            html += '<div style="margin-top:1em;padding:0.8em;background:#23272b;border:1px solid #333;border-radius:4px;">';
            html += '<div style="font-weight:bold;margin-bottom:0.5em;color:#6fcf6f;">Communication Preferences:</div>';
            html += `<div style='margin-bottom:0.3em;'><span style='color:#aaa;'>SMS Opt-in:</span> <span style='color:${smsOptIn === true ? '#6fcf6f' : '#ff8080'};font-weight:bold;'>${smsOptIn === true ? '‚úì Opted In' : smsOptIn === false ? '‚úó Opted Out' : '‚óã Not Set'}</span></div>`;
            html += `<div><span style='color:#aaa;'>Email Opt-in:</span> <span style='color:${emailOptIn === true ? '#6fcf6f' : '#ff8080'};font-weight:bold;'>${emailOptIn === true ? '‚úì Opted In' : emailOptIn === false ? '‚úó Opted Out' : '‚óã Not Set'}</span></div>`;
            html += '</div>';
            html += '</div>';
            // Controls available for admin or case_worker roles
            const canEditCase = userHasRole(['admin', 'case_worker']);
            if (canEditCase) {
                const a = data.applicant || {};
                const newsKeywordsCsv = Array.isArray(a.newsKeywords)
                  ? a.newsKeywords.join(', ')
                  : (a.newsKeywords || '');
                const orgName = (data.referringOrg && data.referringOrg.name) ? data.referringOrg.name : '';
                const contactRaw = data.applicant && data.applicant.contact ? String(data.applicant.contact) : '';
                const normalizedContact = contactRaw.startsWith('+1') ? contactRaw : contactRaw ? `+1${contactRaw.replace(/[^0-9]/g, '')}` : '';
                const canSendSms = userHasRole(['admin', 'case_worker']) && normalizedContact;
                html += `
                <div style="margin: 0.5em 0 1.2em 0; display:flex; flex-direction:column; gap:0.8em;">
                    <button id="editCaseToggleBtn" style="background:#222;color:#6fcf6f;border:none;border-radius:4px;padding:0.35em 1em;font-weight:bold;cursor:pointer;max-width:180px;">‚úèÔ∏è Edit Case</button>
                    <form id="editCaseForm" style="display:none;margin-top:0.3em;">
                        <div style="display:grid;grid-template-columns: 1fr; gap: 0.8em;">
                            <label>Name: <input type="text" name="name" value="${a.name || ''}"></label>
                            <label>Kinship Role: <input type="text" name="kinshipRole" value="${a.kinshipRole || ''}"></label>
                            <label>Status:
                                <select name="status" id="editCaseStatusDropdown" data-current="${a.status || ''}">
                                    <option value="">-- Select Status (optional) --</option>
                                </select>
                            </label>
                            <label>Contact Number: <input type="text" name="contact" value="${a.contact || ''}"></label>
                            <label>Email Address: <input type="email" name="email" value="${a.email || ''}"></label>
                            <label style="grid-column: 1 / -1;">Mailing Address: <input type="text" name="address" value="${a.address || ''}" style="width:100%;"></label>
                            <label>First Nation:
                                <select name="community" id="editCaseCommunityDropdown" data-current="${a.community || ''}">
                                    <option value="">-- Select Community / Nation (optional) --</option>
                                    <option value="Other">Other (not listed)</option>
                                </select>
                            </label>
                            <label>Preferred Language(s): <input type="text" name="language" value="${a.language || ''}"></label>
                            <label>Best Way and Time to Contact You: <input type="text" name="contactTime" value="${a.contactTime || ''}"></label>
                            <label style="grid-column: 1 / -1;">News Alert Keywords (comma-separated): <input type="text" name="newsKeywords" value="${newsKeywordsCsv}" placeholder="e.g., John Doe, Jane Doe, Smith Street"></label>
                            <label style="grid-column:1 / -1;">Referring Organization:
                                <select name="referringOrganization" id="editCaseRefOrgDropdown" data-current="${orgName}">
                                    <option value="">-- Select Referring Organization --</option>
                                </select>
                            </label>
                            <div style="grid-column: 1 / -1; margin-top: 0.5em;">
                                <label style="display: block; margin-bottom: 0.5em;"><input type="checkbox" name="smsOptIn" ${a.smsOptIn ? 'checked' : ''}> Opt-in to receive SMS text messages</label>
                                <label style="display: block;"><input type="checkbox" name="emailOptIn" ${a.emailOptIn ? 'checked' : ''}> Opt-in to receive email updates</label>
                            </div>
                        </div>
                        <div style="margin-top:0.6em;">
                            <button type="submit" style="background:#222;color:#6fcf6f;border:none;border-radius:4px;padding:0.35em 1em;font-weight:bold;cursor:pointer;">Save</button>
                            <button type="button" id="cancelEditCaseBtn" style="margin-left:0.6em;background:#444;color:#fff;border:none;border-radius:4px;padding:0.35em 1em;cursor:pointer;">Cancel</button>
                        </div>
                        <div id="editCaseMsg" style="margin-top:0.5em;color:#a05a5a;"></div>
                    </form>
                    <div style="display:flex;flex-direction:column;gap:0.5em;">
                        <div style="display:flex;align-items:center;gap:0.8em;flex-wrap:wrap;">
                            <button id="toggleSmsFormBtn" ${canSendSms ? '' : 'disabled'} style="background:#222;color:#6fcf6f;border:none;border-radius:4px;padding:0.35em 1em;font-weight:bold;cursor:pointer;max-width:200px;${canSendSms ? '' : 'opacity:0.5;cursor:not-allowed;'}">üì® Send SMS Update</button>
                            ${!canSendSms ? `<span style="color:#a05a5a;font-size:0.95em;">Please enter a phone number to allow SMS.</span>` : ''}
                        </div>
                        <form id="smsForm" style="display:none;max-width:460px;background:#111;padding:0.8em;border-radius:6px;">
                            <div style="display:flex;flex-direction:column;margin-bottom:0.6em;color:#ddd;">
                                <label for="smsToInput">Recipient Phone Number (E.164):</label>
                                <div style="display:flex;align-items:center;gap:0.4em;">
                                    <span style="padding:0.4em 0.6em;background:#222;border:1px solid #444;border-radius:4px;color:#6fcf6f;">+1</span>
                                    <input type="tel" name="smsToInput" id="smsToInput" value="${normalizedContact.replace('+1','')}" placeholder="2045551234" style="flex:1;padding:0.4em;border-radius:4px;border:1px solid #444;background:#000;color:#fff;">
                                </div>
                            </div>
                            <label style="display:block;margin-bottom:0.6em;color:#ddd;">Message:
                                <textarea name="smsBody" id="smsBodyInput" rows="4" placeholder="Short update for the family..." style="width:100%;padding:0.4em;border-radius:4px;border:1px solid #444;background:#000;color:#fff;resize:vertical;"></textarea>
                            </label>
                            <div style="display:flex;gap:0.6em;margin-top:0.4em;">
                                <button type="submit" style="background:#6fcf6f;color:#111;border:none;border-radius:4px;padding:0.35em 1em;font-weight:bold;cursor:pointer;">Send SMS</button>
                                <button type="button" id="cancelSmsBtn" style="background:#444;color:#fff;border:none;border-radius:4px;padding:0.35em 1em;cursor:pointer;">Cancel</button>
                            </div>
                            <div id="smsMsg" style="margin-top:0.6em;color:#a05a5a;"></div>
                        </form>
                    </div>
                </div>`;
            }
        }
        // Show related LovedOne(s) info if present, else show warning
        if (Array.isArray(data.lovedOnes) && data.lovedOnes.length > 0) {
            html += `<hr style="border: none; border-top: 3px solid #444; margin: 1.5em 0;">`;
            html += `<div style="margin-bottom:1.5em;">
                <b>Missing Person(s) Info:</b><br>`;
            data.lovedOnes.forEach(lo => {
                const supportSelections = Array.isArray(lo.supportSelections) ? lo.supportSelections : [];
                const supportCheckboxesHtml = SUPPORT_OPTIONS.map(option => {
                    const checked = supportSelections.includes(option) ? 'checked' : '';
                    return `<label style='display:inline-flex; align-items:center; gap:0.4em;'><input type="checkbox" name="supportSelections" value="${escapeAttr(option)}" ${checked}> ${escapeHtml(option)}</label>`;
                }).join('');
                const otherSupportChecked = supportSelections.includes('Other') ? 'checked' : '';
                const otherSupportValueAttr = escapeAttr(lo.otherSupport || '');
                const additionalNotesValueHtml = escapeHtml(lo.additionalNotes || '');
                html += `<div class='loved-one-card' style='margin:0.5em 0 1em 1em; padding:0.5em; border-left:3px solid #e6b85c;'>`;
                if (lo.name) html += `<div><span style='color:#aaa;'>Name:</span> <span>${lo.name}</span></div>`;
                if (lo.status) html += `<div><span style='color:#aaa;'>Status:</span> <span style='font-weight:bold;color:#6fcf6f;'>${escapeHtml(lo.status)}</span></div>`;
                html += `<div><span style='color:#aaa;'>Coummunity of Loved One:</span> <span>${lo.community || '(not specified)'}</span></div>`;
                if (lo.relationship) html += `<div><span style='color:#aaa;'>Relationship:</span> <span>${lo.relationship}</span></div>`;
                if (lo.dateOfIncident) html += `<div><span style='color:#aaa;'>Date of Incident:</span> <span>${lo.dateOfIncident}</span></div>`;
                if (lo.lastLocation) html += `<div><span style='color:#aaa;'>Last Location:</span> <span>${lo.lastLocation}</span></div>`;
                {
                    const hasLat = (lo.lastLocationLat != null);
                    const hasLon = (lo.lastLocationLon != null);
                    const latTxt = hasLat ? lo.lastLocationLat : '';
                    const lonTxt = hasLon ? lo.lastLocationLon : '';
                    const both = (latTxt !== '' && lonTxt !== '');
                    let content;
                    if (both) {
                        content = `<a href="https://www.google.com/maps?q=${encodeURIComponent(latTxt + ',' + lonTxt)}" target="_blank" rel="noopener">${latTxt}, ${lonTxt}</a>`;
                    } else if (hasLat || hasLon) {
                        content = `${latTxt}${(latTxt!==''&&lonTxt!=='')?', ':''}${lonTxt}`;
                    } else {
                        content = '<i>(not provided)</i>';
                    }
                    html += `<div><span style='color:#aaa;'>Lat/Long:</span> <span>${content}</span></div>`;
                }
                const policeNumber = lo.policeInvestigationNumber || (data.applicant && data.applicant.policeInvestigationNumber) || '';
                const policeDisplay = policeNumber ? policeNumber : '<i>(not provided)</i>';
                html += `<div class='case-detail-row' style='margin-top:0.4em;'><span class='detail-label'>Police Investigation Number:</span> <span class='detail-value'>${policeDisplay}</span></div>`;
                const legalActionNumber = lo.legalActionCaseNumber || '';
                const legalDisplay = legalActionNumber ? legalActionNumber : '<i>(not provided)</i>';
                html += `<div class='case-detail-row' style='margin-top:0.2em;'><span class='detail-label'>Legal Action Case Number:</span> <span class='detail-value'>${legalDisplay}</span></div>`;
                const communitySearchDesc = lo.communitySearchEffortDescription || '';
                const communitySearchDisplay = communitySearchDesc ? communitySearchDesc : '<i>(not provided)</i>';
                html += `<div class='case-detail-row' style='margin-top:0.2em;'><span class='detail-label'>Community Search Effort Description:</span> <span class='detail-value'>${communitySearchDisplay}</span></div>`;
                const investigations = Array.isArray(lo.investigation) ? lo.investigation : [];
                html += `<div class='loved-one-subtitle'>Investigation Status</div>`;
                if (investigations.length) {
                    html += `<ul class='loved-one-list'>${investigations.map(item => `<li>${item}</li>`).join('')}</ul>`;
                } else {
                    html += `<div class='loved-one-muted'>(none recorded)</div>`;
                }
                if (lo.otherInvestigation) {
                    html += `<div class='loved-one-extra'>Other: ${lo.otherInvestigation}</div>`;
                }
                html += `<div class='loved-one-subtitle'>Support, Advocacy, and Requests</div>`;
                if (supportSelections.length) {
                    html += `<ul class='loved-one-list'>${supportSelections.map(item => `<li>${escapeHtml(item)}</li>`).join('')}</ul>`;
                } else {
                    html += `<div class='loved-one-muted'>(none requested)</div>`;
                }
                if (lo.otherSupport) {
                    html += `<div class='loved-one-extra'>Other: ${escapeHtml(lo.otherSupport)}</div>`;
                }
                html += `<div class='loved-one-subtitle'>Additional Notes or Story</div>`;
                if (lo.additionalNotes) {
                    html += `<div class='loved-one-notes'>${additionalNotesValueHtml}</div>`;
                } else {
                    html += `<div class='loved-one-muted'>(not provided)</div>`;
                }
                if (lo.id) {
                    html += `
                    <div style='margin-top:0.6em;'>
                        <button class='editLovedOneBtn' data-id='${lo.id}' style='background:#222;color:#6fcf6f;border:none;border-radius:4px;padding:0.25em 0.8em;font-weight:bold;cursor:pointer;'>‚úèÔ∏è Edit Missing Person</button>
                    </div>
                    <form class='editLovedOneForm' id='editLovedOneForm-${lo.id}' style='display:none;margin:0.6em 0 0 1.5em; padding:0.8em; border-left:2px solid #444; background:rgba(34,34,34,0.15); border-radius:6px;'>
                        <div style='display:grid;grid-template-columns: repeat(2, minmax(220px, 1fr)); gap: 0.8em 2em;'>
                            <label>Name: <input type='text' name='name' value='${lo.name || ''}'></label>
                            <label style='grid-column: 2; display:inline-flex; white-space:normal; align-items:center; gap:0.6em; justify-content: space-between; min-width:0;'>Relationship: <input type='text' name='relationship' value='${lo.relationship || ''}' style='flex:1 1 auto; min-width:0;'></label>
                            <label>Status:
                                <select name='status' class='editStatusDropdown' data-current='${lo.status || ''}'>
                                    <option value=''>-- Select Status (optional) --</option>
                                </select>
                            </label>
                            <label style='grid-column: 1 / -1;'>Date of Incident: <input type='date' name='dateOfIncident' value='${lo.dateOfIncident || ''}'></label>
                            <div style='grid-column:1 / -1; font-weight:bold; text-decoration:underline;'>Investigation Status</div>
                            <label style='grid-column: 1 / -1;'>Police Investigation Number: <input type='text' name='policeInvestigationNumber' value='${lo.policeInvestigationNumber || ''}'></label>
                            <label style='grid-column: 1 / -1;'>Legal Action Case Number: <input type='text' name='legalActionCaseNumber' value='${lo.legalActionCaseNumber || ''}'></label>
                            <label style='grid-column: 1 / -1;'>Community Search Effort Description: <input type='text' name='communitySearchEffortDescription' value='${lo.communitySearchEffortDescription || ''}'></label>
                            <label style='grid-column: 1 / -1; display:inline-flex; white-space:normal; align-items:center; gap:0.6em; justify-content: space-between; min-width:0;'>Last Location: <input type='text' name='lastLocation' value='${lo.lastLocation || ''}' style='flex:1 1 auto; min-width:0;'></label>
                            <label>Lat/Long: <input type='text' name='latlon' value='${(lo.lastLocationLat!=null&&lo.lastLocationLon!=null)?`${lo.lastLocationLat}, ${lo.lastLocationLon}`:''}' placeholder='49.887129, -97.153645'></label>
                            <label style='grid-column:1 / -1;'>Coummunity of Loved One:
                                <select name='community' class='editCommunityDropdown' data-current='${lo.community || ''}'>
                                    <option value=''>-- Select Community / Nation (optional) --</option>
                                    <option value='Other'>Other (not listed)</option>
                                </select>
                            </label>
                            <div style='grid-column:1 / -1; margin-top:0.6em;'>
                                <div style='font-weight:bold;'>Support, Advocacy, and Requests:</div>
                                <div class='edit-support-checkboxes' style='display:flex; flex-wrap:wrap; gap:0.6em 1.2em; margin-top:0.4em;'>
                                    ${supportCheckboxesHtml}
                                    <label style='display:inline-flex; align-items:center; gap:0.4em; flex-wrap:wrap;'>
                                        <input type='checkbox' name='supportSelections' value='Other' ${otherSupportChecked}>
                                        <span>Other Needs or Requests:</span>
                                        <input type='text' name='otherSupport' value='${otherSupportValueAttr}' style='min-width:200px;'>
                                    </label>
                                </div>
                            </div>
                            <label style='grid-column:1 / -1;'>Additional Notes:
                                <textarea name='additionalNotes' rows='3' style='width:100%; resize:vertical;'>${additionalNotesValueHtml}</textarea>
                            </label>
                        </div>
                        <div style='margin-top:0.6em;'>
                            <button type='submit' class='saveLovedOneBtn' data-id='${lo.id}' style='background:#222;color:#6fcf6f;border:none;border-radius:4px;padding:0.35em 1em;font-weight:bold;cursor:pointer;'>Save</button>
                            <button type='button' class='cancelEditLovedOneBtn' data-id='${lo.id}' style='margin-left:0.6em;background:#444;color:#fff;border:none;border-radius:4px;padding:0.35em 1em;cursor:pointer;'>Cancel</button>
                        </div>
                        <div class='editLovedOneMsg' id='editLovedOneMsg-${lo.id}' style='margin-top:0.5em;color:#a05a5a;'></div>
                    </form>`;
                }
                html += `</div>`;
                html += `<hr style="border: none; border-top: 2px dashed #555; margin: 1.2em 0;">`;
            });
            html += `</div>`;
        } else {
                html += `<div style="margin-bottom:1.5em; color: #a05a5a; font-weight: normal;">‚ö†Ô∏è No missing person (Loved One) is attached to this case.</div>`;
        }
        // Add Loved One form toggle and form
        html += `
            <div style='margin: 0.5em 0 1.5em 0;'>
                <button id='addLovedOneToggleBtn' style='background:#222;color:#6fcf6f;border:none;border-radius:4px;padding:0.35em 1em;font-weight:bold;cursor:pointer;'>Add Missing Person</button>
                <form id='addLovedOneForm' style='display:none;margin-top:0.8em;'>
                    <div style='display:grid;grid-template-columns: repeat(2, minmax(220px, 1fr)); gap: 0.8em 2em;'>
                        <label>Name: <input type='text' name='name' required></label>
                        <label style='grid-column: 2; display:inline-flex; white-space:normal; align-items:center; gap:0.6em; justify-content: space-between; min-width:0;'>Relationship: <input type='text' name='relationship' style='flex:1 1 auto; min-width:0;'></label>
                        <label>Status:
                            <select name='status' id='addLovedOneStatusDropdown'>
                                <option value=''>-- Select Status (optional) --</option>
                            </select>
                        </label>
                        <label>Date of Incident: <input type='date' name='incidentDate'></label>
                        <div style='grid-column:1 / -1; font-weight:bold; text-decoration:underline;'>Investigation Status</div>
                        <label style='grid-column: 1 / -1; margin-left:1.5em;'>Police Investigation Number: <input type='text' name='policeInvestigationNumber'></label>
                        <label style='grid-column: 1 / -1; margin-left:1.5em;'>Legal Action Case Number: <input type='text' name='legalActionCaseNumber'></label>
                        <label style='grid-column: 1 / -1; margin-left:1.5em;'>Community Search Effort Description: <input type='text' name='communitySearchEffortDescription'></label>
                        <label style='grid-column: 1 / -1; display:inline-flex; white-space:normal; align-items:center; gap:0.6em; justify-content: space-between; min-width:0;'>Last Location: <input type='text' name='lastLocation' style='flex:1 1 auto; min-width:0;'></label>
                        <label>Lat/Long: <input type='text' name='latlon' placeholder='49.887129, -97.153645'></label>
                        <label style='grid-column:1 / -1;'>Coummunity of Loved One:
                            <select name='community' id='addLovedOneCommunityDropdown'>
                                <option value=''>-- Select Community / Nation (optional) --</option>
                                <option value='Other'>Other (not listed)</option>
                            </select>
                        </label>
                        <div style='grid-column:1 / -1; margin-top:0.6em;'>
                            <div style='font-weight:bold;'>Support, Advocacy, and Requests:</div>
                            <div class='edit-support-checkboxes' style='display:flex; flex-wrap:wrap; gap:0.6em 1.2em; margin-top:0.4em;'>
                                ${SUPPORT_OPTIONS.map(option => `<label style='display:inline-flex; align-items:center; gap:0.4em;'><input type="checkbox" name="supportSelections" value="${escapeAttr(option)}"> ${escapeHtml(option)}</label>`).join('')}
                                <label style='display:inline-flex; align-items:center; gap:0.4em; flex-wrap:wrap;'>
                                    <input type='checkbox' name='supportSelections' value='Other'>
                                    <span>Other Needs or Requests:</span>
                                    <input type='text' name='otherSupport' style='min-width:200px;'>
                                </label>
                            </div>
                        </div>
                        <label style='grid-column:1 / -1;'>Additional Notes:
                            <textarea name='additionalNotes' rows='3' style='width:100%; resize:vertical;'></textarea>
                        </label>
                    </div>
                    <div style='margin-top:0.6em;'>
                        <button type='submit' style='background:#222;color:#6fcf6f;border:none;border-radius:4px;padding:0.35em 1em;font-weight:bold;cursor:pointer;'>Save</button>
                        <button type='button' id='cancelAddLovedOneBtn' style='margin-left:0.6em;background:#444;color:#fff;border:none;border-radius:4px;padding:0.35em 1em;cursor:pointer;'>Cancel</button>
                    </div>
                    <div id='addLovedOneMsg' style='margin-top:0.5em;color:#a05a5a;'></div>
                </form>
            </div>
        `;
        if (data.referringOrg) {
            html += `<b>Referring Organization:</b> ${data.referringOrg.name || ''}`;
            if ('active' in data.referringOrg && !data.referringOrg.active) {
                html += ' <span style="color:#e6b85c;">(deleted)</span>';
            }
            if (data.referringOrg.contact) {
                html += `<br><b>Org Contact:</b> ${data.referringOrg.contact}`;
            }
            if (data.referringOrg.phone) {
                html += `<br><b>Org Phone:</b> ${data.referringOrg.phone}`;
            }
        }
        document.getElementById('caseInfo').innerHTML = html;
        const smsForm = document.getElementById('smsForm');
        const toggleSmsBtn = document.getElementById('toggleSmsFormBtn');
        const cancelSmsBtn = document.getElementById('cancelSmsBtn');
        if (toggleSmsBtn && smsForm) {
            toggleSmsBtn.addEventListener('click', () => {
                if (toggleSmsBtn.disabled) return;
                const isShown = smsForm.style.display === 'block';
                smsForm.style.display = isShown ? 'none' : 'block';
                const smsMsg = document.getElementById('smsMsg');
                if (smsMsg) smsMsg.textContent = '';
            });
        }
        if (cancelSmsBtn && smsForm) {
            cancelSmsBtn.addEventListener('click', () => {
                smsForm.style.display = 'none';
                const smsMsg = document.getElementById('smsMsg');
                if (smsMsg) smsMsg.textContent = '';
            });
        }
        if (smsForm) {
            smsForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const smsMsg = document.getElementById('smsMsg');
                if (smsMsg) smsMsg.textContent = '';
                const localVal = (document.getElementById('smsToInput').value || '').replace(/\\D/g, '');
                const msgVal = (document.getElementById('smsBodyInput').value || '').trim();
                const toVal = localVal ? '+1' + localVal : '';
                if (!toVal || !msgVal) {
                    if (smsMsg) smsMsg.textContent = 'Phone number and message are required.';
                    return;
                }
                try {
                    const res = await fetch('/api/cases/' + encodeURIComponent(getCaseId()) + '/sms', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + getToken()
                        },
                        body: JSON.stringify({ to: toVal, message: msgVal })
                    });
                    const out = await res.json().catch(() => ({}));
                    if (!res.ok || !out.success) {
                        if (smsMsg) smsMsg.textContent = out.error || 'Failed to send SMS.';
                        return;
                    }
                    if (smsMsg) {
                        smsMsg.style.color = '#6fcf6f';
                        smsMsg.textContent = 'SMS sent successfully.';
                    }
                    smsForm.reset();
                    smsForm.style.display = 'none';
                    await fetchCaseInfo(getCaseId());
                    await fetchNotes(getCaseId());
                } catch (err) {
                    if (smsMsg) smsMsg.textContent = 'Network error while sending SMS.';
                }
            });
        }
        // Wire up Edit Case controls
        const editCaseToggleBtn = document.getElementById('editCaseToggleBtn');
        const editCaseForm = document.getElementById('editCaseForm');
        const editCaseMsg = document.getElementById('editCaseMsg');
        const communityDD = document.getElementById('editCaseCommunityDropdown');
        const refOrgDD = document.getElementById('editCaseRefOrgDropdown');
        if (editCaseToggleBtn && editCaseForm) {
            editCaseToggleBtn.addEventListener('click', async () => {
                editCaseForm.style.display = editCaseForm.style.display === 'none' ? 'block' : 'none';
                if (editCaseForm.style.display === 'block') {
                    editCaseMsg.textContent = '';
                    // Populate communities
                    if (communityDD && communityDD.options.length <= 2) {
                        try {
                            const r = await fetch('/api/communities');
                            const d = await r.json();
                            const list = d.communities || d || [];
                            const otherOpt = communityDD.querySelector('option[value="Other"]');
                            list.forEach(c => {
                                const name = c && c.name ? c.name : c;
                                if (!name) return;
                                const opt = document.createElement('option');
                                opt.value = name;
                                opt.textContent = name;
                                communityDD.insertBefore(opt, otherOpt);
                            });
                            const current = communityDD.getAttribute('data-current') || '';
                            if (current) communityDD.value = current;
                        } catch {}
                    }
                    // Populate referring orgs
                    if (refOrgDD && refOrgDD.options.length <= 1) {
                        try {
                            const r2 = await fetch('/api/organizations', { headers: { 'Authorization': 'Bearer ' + getToken() } });
                            const d2 = await r2.json();
                            const orgs = d2.organizations || d2 || [];
                            orgs.forEach(o => {
                                const name = o && o.name ? o.name : o;
                                if (!name) return;
                                const opt = document.createElement('option');
                                opt.value = name;
                                opt.textContent = name;
                                refOrgDD.appendChild(opt);
                            });
                            const currentOrg = refOrgDD.getAttribute('data-current') || '';
                            if (currentOrg) refOrgDD.value = currentOrg;
                        } catch {}
                    }
                    // Populate client status dropdown
                    const statusDD = document.getElementById('editCaseStatusDropdown');
                    if (statusDD && statusDD.options.length <= 1) {
                        try {
                            const r3 = await fetch('/api/client-statuses', {
                                headers: { 'Authorization': 'Bearer ' + getToken() }
                            });
                            const d3 = await r3.json();
                            const list = (d3.statuses || []).filter(s => s.active !== false);
                            list.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                            list.forEach(status => {
                                const opt = document.createElement('option');
                                opt.value = status.name;
                                opt.textContent = status.name;
                                statusDD.appendChild(opt);
                            });
                            const currentStatus = statusDD.getAttribute('data-current') || '';
                            if (currentStatus) statusDD.value = currentStatus;
                        } catch {}
                    }
                }
            });
        }
        const cancelEditCaseBtn = document.getElementById('cancelEditCaseBtn');
        if (cancelEditCaseBtn && editCaseForm) {
            cancelEditCaseBtn.addEventListener('click', () => {
                editCaseForm.style.display = 'none';
                if (editCaseMsg) editCaseMsg.textContent = '';
            });
        }
        if (editCaseForm) {
            editCaseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (editCaseMsg) editCaseMsg.textContent = '';
                const fd = new FormData(editCaseForm);
                const payload = {
                    name: (fd.get('name') || '').trim() || null,
                    kinshipRole: (fd.get('kinshipRole') || '').trim() || null,
                    status: (fd.get('status') || '').trim() || null,
                    contact: (fd.get('contact') || '').trim() || null,
                    email: (fd.get('email') || '').trim() || null,
                    address: (fd.get('address') || '').trim() || null,
                    language: (fd.get('language') || '').trim() || null,
                    community: (fd.get('community') || '').trim() || null,
                    contactTime: (fd.get('contactTime') || '').trim() || null,
                    referringOrganization: (fd.get('referringOrganization') || '').trim(),
                    newsKeywords: (() => {
                        const raw = (fd.get('newsKeywords') || '').trim();
                        if (!raw) return [];
                        return raw.split(',').map(s => s.trim()).filter(Boolean);
                    })(),
                    smsOptIn: fd.get('smsOptIn') === 'on',
                    emailOptIn: fd.get('emailOptIn') === 'on'
                };
                // Normalize empty referringOrganization to null (means remove)
                if (payload.referringOrganization === '') payload.referringOrganization = null;
                try {
                    console.debug('[DEBUG] Case update payload', payload);
                    const resU = await fetch('/api/applicants/' + encodeURIComponent(getCaseId()), {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + getToken()
                        },
                        body: JSON.stringify(payload)
                    });
                    const out = await resU.json().catch(() => ({}));
                    if (!resU.ok || !out.success) {
                        if (editCaseMsg) {
                            editCaseMsg.style.color = '#a05a5a';
                            editCaseMsg.textContent = out.error || 'Failed to update case';
                        }
                        return;
                    }
                    if (editCaseMsg) {
                        editCaseMsg.style.color = '#6fcf6f';
                        editCaseMsg.textContent = 'Case updated';
                    }
                    await fetchCaseInfo(getCaseId());
                    setTimeout(() => {
                        if (editCaseMsg) editCaseMsg.textContent = '';
                        editCaseForm.style.display = 'none';
                    }, 1200);
                } catch (err) {
                    if (editCaseMsg) {
                        editCaseMsg.style.color = '#a05a5a';
                        editCaseMsg.textContent = 'Failed to update case';
                    }
                }
            });
        }
        // Wire up Add Loved One controls
        const toggleBtn = document.getElementById('addLovedOneToggleBtn');
        const formEl = document.getElementById('addLovedOneForm');
        const cancelBtn = document.getElementById('cancelAddLovedOneBtn');
        const msgEl = document.getElementById('addLovedOneMsg');
        const communityDropdown = document.getElementById('addLovedOneCommunityDropdown');
        if (toggleBtn && formEl) {
            toggleBtn.addEventListener('click', async () => {
                formEl.style.display = formEl.style.display === 'none' ? 'block' : 'none';
                msgEl.textContent = '';
                // Populate communities when opening
                if (formEl.style.display === 'block' && communityDropdown && communityDropdown.options.length <= 2) {
                    try {
                        const r = await fetch('/api/communities');
                        const d = await r.json();
                        const list = d.communities || d || [];
                        const otherOpt = communityDropdown.querySelector('option[value="Other"]');
                        list.forEach(c => {
                            const name = c && c.name ? c.name : c;
                            if (!name) return;
                            const opt = document.createElement('option');
                            opt.value = name;
                            opt.textContent = name;
                            communityDropdown.insertBefore(opt, otherOpt);
                        });
                    } catch {}
                }
                // Populate status dropdown when opening
                const statusDropdown = document.getElementById('addLovedOneStatusDropdown');
                if (formEl.style.display === 'block' && statusDropdown && statusDropdown.options.length <= 1) {
                    try {
                        const r = await fetch('/api/loved-one-statuses', {
                            headers: { 'Authorization': 'Bearer ' + getToken() }
                        });
                        const d = await r.json();
                        const list = (d.statuses || []).filter(s => s.active !== false);
                        list.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                        list.forEach(status => {
                            const opt = document.createElement('option');
                            opt.value = status.name;
                            opt.textContent = status.name;
                            statusDropdown.appendChild(opt);
                        });
                    } catch {}
                }
            });
        }
        if (cancelBtn && formEl) {
            cancelBtn.addEventListener('click', () => { formEl.style.display = 'none'; msgEl.textContent = ''; });
        }
        // Parse a single "lat, lon" or "lat lon" string into {lat, lon}
        function parseLatLon(text) {
            const s = (text || '').trim();
            if (!s) return { lat: null, lon: null };
            const parts = s.split(/[ ,]+/).filter(Boolean);
            let lat = null, lon = null;
            if (parts.length >= 2) {
                const la = parseFloat(parts[0]);
                const lo = parseFloat(parts[1]);
                lat = isFinite(la) ? la : null;
                lon = isFinite(lo) ? lo : null;
            }
            return { lat, lon };
        }

        if (formEl) {
            formEl.addEventListener('submit', async (e) => {
                e.preventDefault();
                msgEl.textContent = '';
                const fd = new FormData(formEl);
                const payload = {
                    name: fd.get('name'),
                    relationship: fd.get('relationship') || '',
                    status: fd.get('status') || '',
                    incidentDate: fd.get('incidentDate') || '',
                    lastLocation: fd.get('lastLocation') || '',
                    community: fd.get('community') || '',
                    policeInvestigationNumber: (fd.get('policeInvestigationNumber') || '').trim(),
                    legalActionCaseNumber: (fd.get('legalActionCaseNumber') || '').trim(),
                    communitySearchEffortDescription: (fd.get('communitySearchEffortDescription') || '').trim()
                };
                const selectedSupportsAdd = Array.from(formEl.querySelectorAll("input[name='supportSelections']:checked")).map(cb => cb.value);
                payload.supportSelections = selectedSupportsAdd;
                payload.otherSupport = (fd.get('otherSupport') || '').trim();
                payload.additionalNotes = (fd.get('additionalNotes') || '').trim();
                console.debug('[DEBUG] Add loved one payload', payload);
                const pLL = parseLatLon(fd.get('latlon'));
                if (pLL.lat != null) payload.lastLocationLat = pLL.lat;
                if (pLL.lon != null) payload.lastLocationLon = pLL.lon;
                try {
                    const res2 = await fetch('/api/applicants/' + encodeURIComponent(getCaseId()) + '/loved-ones', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + getToken()
                        },
                        body: JSON.stringify(payload)
                    });
                    const out = await res2.json().catch(() => ({}));
                    console.debug('[DEBUG] Add loved one response', out);
                    if (!res2.ok || !out.success) {
                        msgEl.textContent = out.error || 'Failed to add Loved One';
                        return;
                    }
                    formEl.reset();
                    formEl.style.display = 'none';
                    await fetchCaseInfo(getCaseId());
                } catch (err) {
                    msgEl.textContent = 'Network error';
                }
            });
        }
        // Wire up Edit Loved One controls
        document.querySelectorAll('.editLovedOneBtn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const id = btn.getAttribute('data-id');
                const form = document.getElementById('editLovedOneForm-' + id);
                const msg = document.getElementById('editLovedOneMsg-' + id);
                if (!form) return;
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
                msg.textContent = '';
                if (form.style.display === 'block') {
                    const dd = form.querySelector('.editCommunityDropdown');
                    if (dd && dd.options.length <= 2) {
                        try {
                            const r = await fetch('/api/communities');
                            const d = await r.json();
                            const list = d.communities || d || [];
                            const otherOpt = dd.querySelector('option[value="Other"]');
                            list.forEach(c => {
                                const name = c && c.name ? c.name : c;
                                if (!name) return;
                                const opt = document.createElement('option');
                                opt.value = name;
                                opt.textContent = name;
                                dd.insertBefore(opt, otherOpt);
                            });
                        } catch {}
                        const current = dd.getAttribute('data-current') || '';
                        if (current) dd.value = current;
                    }
                    // Populate status dropdown
                    const statusDD = form.querySelector('.editStatusDropdown');
                    if (statusDD && statusDD.options.length <= 1) {
                        try {
                            const r = await fetch('/api/loved-one-statuses', {
                                headers: { 'Authorization': 'Bearer ' + getToken() }
                            });
                            const d = await r.json();
                            const list = (d.statuses || []).filter(s => s.active !== false);
                            list.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                            list.forEach(status => {
                                const opt = document.createElement('option');
                                opt.value = status.name;
                                opt.textContent = status.name;
                                statusDD.appendChild(opt);
                            });
                            const currentStatus = statusDD.getAttribute('data-current') || '';
                            if (currentStatus) statusDD.value = currentStatus;
                        } catch {}
                    }
                }
            });
        });
        document.querySelectorAll('.cancelEditLovedOneBtn').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-id');
                const form = document.getElementById('editLovedOneForm-' + id);
                const msg = document.getElementById('editLovedOneMsg-' + id);
                if (form) form.style.display = 'none';
                if (msg) msg.textContent = '';
            });
        });
        document.querySelectorAll('.editLovedOneForm').forEach(form => {
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = form.id.replace('editLovedOneForm-', '');
                const msg = document.getElementById('editLovedOneMsg-' + id);
                const fd = new FormData(form);
                const payload = {
                    applicantId: getCaseId(),
                    name: fd.get('name') || null,
                    relationship: fd.get('relationship') || null,
                    status: fd.get('status') || null,
                    dateOfIncident: fd.get('dateOfIncident') || null,
                    lastLocation: fd.get('lastLocation') || null,
                    community: fd.get('community') || null,
                    policeInvestigationNumber: (fd.get('policeInvestigationNumber') || '').trim() || null,
                    legalActionCaseNumber: (fd.get('legalActionCaseNumber') || '').trim() || null,
                    communitySearchEffortDescription: (fd.get('communitySearchEffortDescription') || '').trim() || null
                };
                const selectedSupportsEdit = Array.from(form.querySelectorAll("input[name='supportSelections']:checked")).map(cb => cb.value);
                payload.supportSelections = selectedSupportsEdit;
                const otherSupportVal = (fd.get('otherSupport') || '').trim();
                payload.otherSupport = otherSupportVal || null;
                const additionalNotesVal = (fd.get('additionalNotes') || '').trim();
                payload.additionalNotes = additionalNotesVal || null;
                const communitySearchVal = (fd.get('communitySearchEffortDescription') || '').trim();
                payload.communitySearchEffortDescription = communitySearchVal || null;
                console.debug('[DEBUG] Update loved one payload', payload);
                const pLL = (function(){
                    const s = (fd.get('latlon') || '').trim();
                    if (!s) return {lat:null, lon:null};
                    const parts = s.split(/[ ,]+/).filter(Boolean);
                    let lat = null, lon = null;
                    if (parts.length >= 2) {
                        const la = parseFloat(parts[0]);
                        const lo = parseFloat(parts[1]);
                        lat = isFinite(la) ? la : null;
                        lon = isFinite(lo) ? lo : null;
                    }
                    return {lat, lon};
                })();
                if (pLL.lat != null) payload.lastLocationLat = pLL.lat;
                if (pLL.lon != null) payload.lastLocationLon = pLL.lon;
                try {
                    const res3 = await fetch('/api/loved-ones/' + encodeURIComponent(id), {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + getToken()
                        },
                        body: JSON.stringify(payload)
                    });
                    const out = await res3.json().catch(() => ({}));
                    console.debug('[DEBUG] Update loved one response', out);
                    if (!res3.ok || !out.success) {
                        if (msg) msg.textContent = out.error || 'Failed to update Loved One';
                        return;
                    }
                    form.style.display = 'none';
                    await fetchCaseInfo(getCaseId());
                } catch (err) {
                    if (msg) msg.textContent = 'Network error';
                }
            });
        });
    }
    async function fetchNotes(caseId) {
        // Fetch both notes and events, merge and sort by timestamp
        const [notesRes, eventsRes] = await Promise.all([
            fetch(`/api/cases/${encodeURIComponent(caseId)}/notes`, {
                headers: { 'Authorization': 'Bearer ' + getToken() }
            }),
            fetch(`/api/cases/${encodeURIComponent(caseId)}/events`, {
                headers: { 'Authorization': 'Bearer ' + getToken() }
            })
        ]);
        const notesDiv = document.getElementById('notesList');
        notesDiv.innerHTML = '';
        if (!notesRes.ok && !eventsRes.ok) {
            notesDiv.innerHTML = '<i>No notes or events found or failed to load.</i>';
            return;
        }
        let notes = [];
        if (notesRes.ok) {
            const data = await notesRes.json();
            if (data.notes) {
                notes = data.notes.map(n => ({
                    type: 'note',
                    text: n.text,
                    author: n.author,
                    timestamp: n.timestamp
                }));
            }
        }
        let events = [];
        if (eventsRes.ok) {
            const data = await eventsRes.json();
            if (data.events) {
                events = data.events.map(e => ({
                    type: e.type || 'event',
                    text: e.description,
                    author: e.user,
                    timestamp: e.timestamp,
                    filename: e.filename,
                    originalname: e.originalname
                }));
            }
        }
        const allItems = [...notes, ...events];
        if (allItems.length === 0) {
            notesDiv.innerHTML = '<i>No notes or events yet.</i>';
            return;
        }
        // Sort newest first
        allItems.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            allItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'note';
                let label = item.type === 'note' ? 'Note' : (item.type === 'file_upload' ? 'File Upload' : 'Event');
                let content = item.text;
                if (item.type === 'file_upload' && item.filename && item.originalname) {
                    const url = `/uploads/${encodeURIComponent(item.filename)}`;
                    // Try to extract uploader from the description
                    let uploader = '';
                    const match = item.text.match(/uploaded by (.+)$/);
                    if (match) {
                        uploader = match[1];
                    }
                    content = `File <a href="${url}" target="_blank" rel="noopener" class="file-upload-link">${item.originalname}</a> uploaded by ${uploader}`;
                }
                div.innerHTML = `<div class="note-meta"><b>${label}</b> &mdash; ${item.author || 'Unknown'} &mdash; ${new Date(item.timestamp).toLocaleString()}</div><div>${content}</div>`;
                notesDiv.appendChild(div);
        });
    }
    document.getElementById('addNoteForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const caseId = getCaseId();
        const text = e.target.noteText.value.trim();
        if (!text) return;
        const res = await fetch(`/api/cases/${encodeURIComponent(caseId)}/notes`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getToken() },
            body: JSON.stringify({ text })
        });
        const result = await res.json();
        const msgDiv = document.getElementById('message');
        if (result.success) {
            msgDiv.textContent = 'Note added';
            msgDiv.style.opacity = '1';
            setTimeout(() => {
                msgDiv.style.opacity = '0';
                setTimeout(() => { msgDiv.textContent = ''; }, 300);
            }, 900);
            e.target.reset();
            await fetchNotes(caseId);
        } else {
            msgDiv.textContent = result.error || 'Failed to add note.';
            msgDiv.classList.add('error');
            msgDiv.style.opacity = '1';
            setTimeout(() => {
                msgDiv.classList.remove('error');
                msgDiv.style.opacity = '0';
                setTimeout(() => { msgDiv.textContent = ''; }, 300);
            }, 1800);
        }
        if (result.success) {
            e.target.reset();
            await fetchNotes(caseId);
        }
    });
    // Initial load
    const caseId = getCaseId();
    if (caseId) {
        fetchCaseInfo(caseId);
        fetchNotes(caseId);
        fetchFiles(caseId);
    } else {
        document.getElementById('caseInfo').textContent = 'No case selected.';
    }
    </script>
</body>
</html>
