<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Missing Persons Case Management - Staff Portal</title>
    <link rel="stylesheet" href="retro.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Roboto:wght@400;500&family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <script src="auth-check.js"></script>
    <script src="navbar.js"></script>
    <script src="navbar-auth.js"></script>
    <!-- Removed stray CSS that was being rendered as text. Styles are now in retro.css -->
</head>
<body>
    <header style="position:relative;">
        <h1 style="text-align:center;">Missing Persons Case Management</h1>
        <button id="themeToggleBtn" title="Toggle dark/light mode" style="position:absolute;top:18px;right:32px;padding:0.5em 1.2em;font-size:1em;border-radius:6px;border:none;background:#222;color:#fff;cursor:pointer;z-index:1001;">ðŸŒ™</button>
    <!-- Navigation will be injected here -->
    </header>
    <main>
    <script>
    // --- Auth check and logout logic ---
    function getToken() {
        const match = document.cookie.match(/(^| )token=([^;]+)/);
        if (match) return match[2];
        return localStorage.getItem('token') || sessionStorage.getItem('token') || '';
    }

    document.addEventListener('DOMContentLoaded', function() {
        // No special content for unauthenticated users
        var logoutLink = document.querySelector('a[href="#"]');
        if (logoutLink) {
            logoutLink.addEventListener('click', function(e) {
                e.preventDefault();
                // Clear cookie
                document.cookie = 'token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax';
                localStorage.removeItem('token');
                sessionStorage.removeItem('token');
                // Use replace to prevent back button access
                window.location.replace('login.html');
            });
        }
        // Theme toggle logic
        var themeBtn = document.getElementById('themeToggleBtn');
        var body = document.body;
        function setTheme(mode) {
            if (mode === 'light') {
                body.classList.add('light-mode');
                if (themeBtn) themeBtn.textContent = 'â˜€ï¸';
            } else {
                body.classList.remove('light-mode');
                if (themeBtn) themeBtn.textContent = 'ðŸŒ™';
            }
        }
        
        // Load theme from database (user preferences) or fallback to localStorage
        function loadTheme() {
            // First try to get from API (user preferences)
            var token = getToken();
            if (token) {
                fetch('/api/user/preferences', {
                    headers: { 'Authorization': 'Bearer ' + token }
                })
                .then(r => r.json())
                .then(data => {
                    var theme = (data.preferences && data.preferences.themeMode) || localStorage.getItem('themeMode') || 'dark';
                    setTheme(theme);
                    // Sync to localStorage as backup
                    localStorage.setItem('themeMode', theme);
                })
                .catch(err => {
                    console.warn('Failed to load theme from preferences, using localStorage:', err);
                    var savedTheme = localStorage.getItem('themeMode');
                    setTheme(savedTheme === 'light' ? 'light' : 'dark');
                });
            } else {
                // No token, use localStorage only
                var savedTheme = localStorage.getItem('themeMode');
                setTheme(savedTheme === 'light' ? 'light' : 'dark');
            }
        }
        
        loadTheme();
        
        // Load and apply font preference
        function loadAndApplyFontPreference() {
            var token = getToken();
            if (token) {
                fetch('/api/user/preferences', {
                    headers: { 'Authorization': 'Bearer ' + token }
                })
                .then(r => r.json())
                .then(data => {
                    const prefs = data.preferences || {};
                    if (prefs.fontFamily) {
                        applyFontPreference(prefs.fontFamily);
                    } else {
                        // New user - apply default font (Inter)
                        applyFontPreference('Inter');
                    }
                })
                .catch(err => {
                    console.warn('Failed to load font preference:', err);
                    // Apply default font on error
                    applyFontPreference('Inter');
                });
            } else {
                // No token - apply default font
                applyFontPreference('Inter');
            }
        }
        
        function applyFontPreference(fontFamily) {
            // Default to Inter if no font specified
            const defaultFont = 'Inter';
            if (!fontFamily) {
                fontFamily = defaultFont;
            }
            let styleEl = document.getElementById('userFontPreference');
            if (!styleEl) {
                styleEl = document.createElement('style');
                styleEl.id = 'userFontPreference';
                document.head.appendChild(styleEl);
            }
            
            const fontStacks = {
                'Fira Mono': "'Fira Mono', 'Consolas', 'Roboto Mono', 'Courier New', monospace",
                'Poppins': "Poppins, ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif",
                'Roboto': "Roboto, ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif",
                'Inter': "Inter, ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif",
                'Georgia': "Georgia, 'Times New Roman', Times, serif"
            };
            
            const fontStack = fontStacks[fontFamily] || fontStacks[defaultFont];
            styleEl.textContent = `body, body * { font-family: ${fontStack} !important; }`;
        }
        
        // Load font preference, defaulting to Inter for new users
        loadAndApplyFontPreference();
        
        // Apply default font if no preference is loaded
        setTimeout(function() {
            if (!document.getElementById('userFontPreference')) {
                applyFontPreference('Inter');
            }
        }, 500);
        
        if (themeBtn) {
            themeBtn.addEventListener('click', function() {
                var current = body.classList.contains('light-mode') ? 'light' : 'dark';
                var next = current === 'light' ? 'dark' : 'light';
                setTheme(next);
                localStorage.setItem('themeMode', next);
                
                // Save to database (user preferences)
                var token = getToken();
                if (token) {
                    fetch('/api/user/preferences', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({ preferences: { themeMode: next } })
                    })
                    .catch(err => console.warn('Failed to save theme preference:', err));
                }
            });
        }
    });
    </script>
    <!-- Removed duplicate navigation bar -->
        

        </main>
        <div id="dbStatusBox"></div>
</main>
<style>
#dbStatusBox {
    display: none;
    position: fixed;
    left: 0; right: 0; bottom: 0;
    margin-left: auto;
    margin-right: auto;
    width: 100%;
    max-width: 900px;
    background: #000;
    color: #4aff4a;
    font-family: 'Consolas', 'Courier New', monospace;
    font-size: 0.9rem;
    padding: 0.9rem 1.2rem 0.9rem 1.2rem;
    border-top: 2px solid #4aff4a;
    z-index: 9999;
    text-align: left;
    letter-spacing: 0.03em;
    box-shadow: 0 -2px 12px #000a;
    user-select: none;
    left: 50%;
    transform: translateX(-50%);
}
@keyframes blink {
    0%, 49% { opacity: 1; }
    50%, 100% { opacity: 0; }
}
.green-cursor {
    display:inline-block;
    width:0.7em;
    background:transparent;
    color:#4aff4a;
    font-weight:bold;
    animation: blink 1s steps(1) infinite;
}
</style>
<script>
// --- DB Health Check: Show retro warning and disable nav if DB is unavailable ---
function showDbStatusBox(msg) {
    const box = document.getElementById('dbStatusBox');
    box.innerHTML =
        '<span style="color:#4aff4a;">[DB STATUS]</span> ' +
        msg +
        ' <span class="green-cursor">â–ˆ</span>';
    box.style.display = 'block';
}

function setNavLinksEnabled(enabled) {
    const ids = ['myCasesLink', 'allCasesLink', 'adminLink'];
    ids.forEach(id => {
        const link = document.getElementById(id);
        if (link) {
            link.style.opacity = enabled ? '' : '0.5';
            link.style.cursor = enabled ? '' : 'not-allowed';
            if (!enabled) {
                // Add click handler to show DB error box
                link.addEventListener('click', dbDownHandler, { once: false });
            } else {
                // Remove click handler if DB is up
                link.removeEventListener('click', dbDownHandler, false);
            }
        }
    });
}

function dbDownHandler(e) {
    e.preventDefault();
    showDbStatusBox('Database unavailable. Please try again later.');
}

fetch('/api/health/db')
    .then(r => {
        if (!r.ok) throw new Error('DB unavailable');
        return r.json();
    })
    .then(data => {
        if (data.db !== 'available') {
            showDbStatusBox('Database unavailable. Please try again later.');
            setNavLinksEnabled(false);
        }
    })
    .catch(() => {
        showDbStatusBox('Database unavailable. Please try again later.');
        setNavLinksEnabled(false);
    });
// Show/hide login, logout, and My Cases links based on token
function updateAuthLinks() {
    const token = getToken();
    const loginLink = document.getElementById('loginLink');
    const logoutLink = document.getElementById('logoutLink');
    const myCasesLink = document.getElementById('myCasesLink');
    const allCasesLink = document.getElementById('allCasesLink');
    const intakeFormLink = Array.from(document.getElementsByTagName('a')).find(a => a.getAttribute('href') === 'intake.html');
    if (token) {
        if (loginLink) loginLink.style.display = 'none';
        if (logoutLink) logoutLink.style.display = '';
        if (myCasesLink) myCasesLink.style.display = '';
        if (allCasesLink) allCasesLink.style.display = '';
        if (intakeFormLink) intakeFormLink.style.display = '';
    } else {
        if (loginLink) loginLink.style.display = '';
        if (logoutLink) logoutLink.style.display = 'none';
        if (myCasesLink) myCasesLink.style.display = 'none';
        if (allCasesLink) allCasesLink.style.display = 'none';
        if (intakeFormLink) intakeFormLink.style.display = 'none';
    }
}
updateAuthLinks();
document.getElementById('logoutLink').addEventListener('click', function(e) {
    e.preventDefault();
    localStorage.removeItem('token');
    sessionStorage.removeItem('token');
    window.location.href = 'login.html';
});
// Hide Admin Panel link if user is not admin
function parseJwt(token) {
    try {
        return JSON.parse(atob(token.split('.')[1]));
    } catch (e) {
        return null;
    }
}
function getToken() {
    return localStorage.getItem('token') || sessionStorage.getItem('token');
}
function isAdmin() {
    const token = getToken();
    if (!token) return false;
    const payload = parseJwt(token);
    return payload && Array.isArray(payload.roles) && payload.roles.includes('admin');
}
if (!isAdmin()) {
    const adminLink = document.getElementById('adminLink');
    if (adminLink) adminLink.style.display = 'none';
}
</script>
</body>
</html>
