<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Missing Persons App</title>
    <link rel="stylesheet" href="retro.css">
    <script src="navbar.js"></script>
    <script src="navbar-auth.js"></script>
</head>
<body>
    <header>
        <h1 style="text-align:center;">Missing Persons Case Management</h1>
        <!-- Navigation will be injected here -->
    </header>
    <main>
        <div style="display:flex;gap:2rem;justify-content:center;margin-bottom:2rem;align-items:center;">
            <a href="#" id="showUsers" class="admin2-nav-link">Advocate Logins</a>
            <a href="#" id="showClients" class="admin2-nav-link">Assign case to Advocate</a>
            <a href="#" id="showSettings" class="admin2-nav-link">System Settings</a>
        </div>
        <div id="message"></div>
        <section id="users" style="display:block;">
            <h2>Create new user account</h2>
            <div id="createUserFormBox" style="background:#181818;padding:0.25em 2em 0.25em 2em;border-radius:10px;max-width:800px;margin:0 0 2em 0;">
                <form id="createUserForm" autocomplete="off">
                    <div class="form-row" style="display:flex;flex-wrap:wrap;gap:1em;">
                        <label>Name: <input type="text" name="name" required></label>
                        <label>Email: <input type="email" name="email" required></label>
                    </div>
                    <div class="form-row" style="display:flex;gap:1em;">
                        <label>Password: <input type="password" name="password" id="password" required minlength="6"></label>
                        <label>Confirm Password: <input type="password" name="confirmPassword" id="confirmPassword" required minlength="6"></label>
                    </div>
                    <div class="form-row" style="display:flex;gap:1em;margin-top:0.5em;align-items:center;justify-content:center;">
                        <label style="margin-bottom:0;">Role:
                            <select name="role" required>
                                <option value="case_worker">Case Worker</option>
                                <option value="admin">Admin</option>
                            </select>
                        </label>
                        <button type="submit">Create User</button>
                    </div>
                    </div>
                    <div id="passwordError" style="color:#ff6666;margin-top:0.5em;display:none;">Passwords do not match.</div>
                </form>
            </div>
            <table id="usersTable" style="border:none; border-collapse:collapse;">
                <thead><tr><th style="border:none !important;">Name</th><th style="border:none !important;">Email</th><th style="border:none !important;">Roles</th></tr></thead>
                <tbody></tbody>
            </table>
            <style>
                #usersTable th, #usersTable td {
                    border: none !important;
                }
            </style>
        </section>
        <section id="clients" style="display:none;">
            <h2>Assign Client</h2>
            <table id="casesTable">
                <thead><tr><th>Name</th><th>Current Case Worker / Unassign</th><th>Assign to Case Worker</th></tr></thead>
                <tbody></tbody>
            </table>
        </section>
        <section id="settings" style="display:none;">
            <h2>System Settings</h2>
            <div style="display:flex;gap:2rem;align-items:flex-start;flex-wrap:nowrap;overflow-x:auto;">
                <div style="flex:0 0 50%;max-width:50%;min-width:340px;background:#23272b;padding:1rem;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                    <h3>Organizations</h3>
                    <form id="addOrganizationForm">
                        <div class="fields">
                            <div style="display:flex;align-items:center;gap:0.5em;margin-bottom:0.5em;">
                                <label for="organizationName" style="min-width:70px;">Name*:</label>
                                <input type="text" id="organizationName" required style="flex:1;">
                            </div>
                            <div style="display:flex;align-items:center;gap:0.5em;margin-bottom:0.5em;">
                                <label for="organizationContact" style="min-width:70px;">Contact:</label>
                                <input type="text" id="organizationContact" style="flex:1;">
                            </div>
                            <div style="display:flex;align-items:center;gap:0.5em;margin-bottom:0.5em;">
                                <label for="organizationPhone" style="min-width:70px;">Phone:</label>
                                <input type="text" id="organizationPhone" style="flex:1;">
                            </div>
                        </div>
                        <button type="submit">Add Organization</button>
                    </form>
                    <h4 style="margin-top:1.5rem;">Current Organizations:</h4>
                    <div class="list" id="organizationList"></div>
                </div>
                <div style="flex:0 0 50%;max-width:50%;min-width:340px;background:#23272b;padding:1rem;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                    <h3>First Nations</h3>
                    <button id="showAddFNFormBtn" style="margin-bottom:1em;">Add First Nation?</button>
                    <div id="addFNModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center;">
                        <div style="background:#181818;padding:2em 2.5em;border-radius:10px;max-width:420px;margin:auto;box-shadow:0 2px 16px #000;position:relative;">
                            <button id="closeAddFNModal" style="position:absolute;top:0.7em;right:1em;background:none;color:#6fcf6f;font-size:1.5em;border:none;cursor:pointer;">&times;</button>
                            <form id="addCommunityForm">
                                <div class="fields">
                                    <label>Name*:<br><input type="text" id="communityName" required></label>
                                    <label>Band Number:<br><input type="text" id="bandNumber"></label>
                                    <label>Address*:<br><input type="text" id="address" required></label>
                                    <label>Phone*:<br><input type="text" id="phone" required></label>
                                    <label>Fax:<br><input type="text" id="fax"></label>
                                    <label>Latitude*:<br><input type="number" id="latitude" step="any" required></label>
                                    <label>Longitude*:<br><input type="number" id="longitude" step="any" required></label>
                                </div>
                                <button type="submit">Add First Nation</button>
                            </form>
                        </div>
                    </div>
                    <ul id="firstNationsList" style="list-style:none;padding:0;margin:0;"></ul>
                </div>
            </div>
        </section>
    </main>
    <script>
    // --- Admin role check: redirect non-admins ---
    (function() {
        function checkAdminAndRedirect() {
            // Robust cookie parsing
            function getToken() {
                const match = document.cookie.match(/(^| )token=([^;]+)/);
                if (match) return match[2];
                return localStorage.getItem('token') || sessionStorage.getItem('token') || '';
            }
            var token = getToken();
            if (!token) {
                window.location.replace('login.html');
                return;
            }
            try {
                var payload = JSON.parse(atob(token.split('.')[1]));
                var roles = payload.roles || payload.groups || payload.roles_claim || [];
                if (!Array.isArray(roles)) roles = [roles];
                if (!roles.includes('admin')) {
                    // Redirect to dashboard instead of index.html to avoid double redirect
                    window.location.replace('dashboard.html');
                }
            } catch (e) {
                window.location.replace('login.html');
            }
        }
        // Wait for DOM to be ready, then check
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', checkAdminAndRedirect);
        } else {
            // Small delay to ensure token is available
            setTimeout(checkAdminAndRedirect, 100);
        }
    })();

    document.addEventListener('DOMContentLoaded', function() {
        // Handle create user form submission
        document.getElementById('createUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = this.name.value.trim();
            const email = this.email.value.trim();
            const password = this.password.value;
            const confirmPassword = this.confirmPassword.value;
            const role = this.role.value;
            if (!name || !email || !password || !confirmPassword || !role) {
                document.getElementById('passwordError').textContent = 'All fields are required.';
                document.getElementById('passwordError').style.display = 'block';
                return;
            }
            if (password !== confirmPassword) {
                document.getElementById('passwordError').textContent = 'Passwords do not match.';
                document.getElementById('passwordError').style.display = 'block';
                return;
            }
            document.getElementById('passwordError').style.display = 'none';
            const token = getToken();
            const res = await fetch('/api/users', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ name, email, password, roles: [role] })
            });
            const result = await res.json();
            if (result.success) {
                this.reset();
                loadUsers();
            } else {
                document.getElementById('passwordError').textContent = result.error || 'Failed to create user.';
                document.getElementById('passwordError').style.display = 'block';
            }
        });
        // Section toggling
        function showSection(section) {
            document.getElementById('users').style.display = 'none';
            document.getElementById('clients').style.display = 'none';
            document.getElementById('settings').style.display = 'none';
            document.getElementById(section).style.display = 'block';
            if (section === 'users') loadUsers();
            if (section === 'clients') loadCases();
            if (section === 'settings') {
                loadOrganizations();
                loadFirstNations();
            }
        }
        document.getElementById('showUsers').addEventListener('click', function(e) {
            e.preventDefault();
            showSection('users');
        });
        document.getElementById('showClients').addEventListener('click', function(e) {
            e.preventDefault();
            showSection('clients');
        });
        
        document.getElementById('showSettings').addEventListener('click', function(e) {
            e.preventDefault();
            showSection('settings');
        });
        
        // Show users table on initial page load
        showSection('users');

        // Modal logic for Add First Nation
        var addFNModal = document.getElementById('addFNModal');
        document.getElementById('showAddFNFormBtn').onclick = function() {
            addFNModal.style.display = 'flex';
        };
        document.getElementById('closeAddFNModal').onclick = function() {
            addFNModal.style.display = 'none';
        };
        addFNModal.onclick = function(e) {
            if (e.target === addFNModal) addFNModal.style.display = 'none';
        };

        // --- Auth and logout logic ---
        function getToken() {
            // Robust cookie parsing
            const cookies = document.cookie.split(';');
            for (let c of cookies) {
                const [key, value] = c.trim().split('=');
                if (key === 'token') return value;
            }
            return localStorage.getItem('token') || sessionStorage.getItem('token') || '';
        }
        if (!getToken()) {
            // Removed duplicate token check and redirect
        }
        var logoutBtn = document.getElementById('logoutBtn');
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function(e) {
                e.preventDefault();
                // Clear cookie
                document.cookie = 'token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT; SameSite=Lax';
                localStorage.removeItem('token');
                sessionStorage.removeItem('token');
                // Use replace to prevent back button access
                window.location.replace('login.html');
            });
        }

        // --- Advocate Logins Management ---
        function loadUsers() {
            const token = getToken();
            fetch('/api/users', {
                headers: { 'Authorization': 'Bearer ' + getToken() }
            })
            .then(r => r.json())
            .then(data => {
                const users = data.users || [];
                const tbody = document.querySelector('#usersTable tbody');
                tbody.innerHTML = '';
                if (users.length === 0) {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = 3;
                    td.textContent = 'No users found.';
                    tr.appendChild(td);
                    tbody.appendChild(tr);
                    return;
                }
                users.forEach(u => {
                    const tr = document.createElement('tr');
                    const nameTd = document.createElement('td');
                    nameTd.textContent = u.name || '';
                    tr.appendChild(nameTd);
                    const emailTd = document.createElement('td');
                    emailTd.textContent = u.email || '';
                    tr.appendChild(emailTd);
                    const rolesTd = document.createElement('td');
                    rolesTd.textContent = Array.isArray(u.roles) ? u.roles.join(', ') : (u.roles || '');
                    tr.appendChild(rolesTd);
                    tbody.appendChild(tr);
                });
            });
        }

        // --- Case Assignment Management ---
        function loadCases() {
            const token = getToken();
            fetch('/api/cases', {
                headers: { 'Authorization': 'Bearer ' + getToken() }
            })
            .then(r => r.json())
            .then(data => {
                const cases = data.cases || [];
                const table = document.getElementById('casesTable').getElementsByTagName('tbody')[0];
                table.innerHTML = '';
                if (cases.length === 0) {
                    const tr = document.createElement('tr');
                    const td = document.createElement('td');
                    td.colSpan = 3;
                    td.textContent = 'No cases found.';
                    tr.appendChild(td);
                    table.appendChild(tr);
                    return;
                }
                cases.forEach(c => {
                    const tr = document.createElement('tr');
                    // Name column
                    const nameTd = document.createElement('td');
                    nameTd.textContent = c.name || c.id || '(no name)';
                    tr.appendChild(nameTd);
                    // Current Case Worker / Unassign column
                    const currentTd = document.createElement('td');
                    let assigned = c.assignedTo && c.assignedTo.length > 0;
                    if (assigned) {
                        currentTd.textContent = c.assignedTo.join(', ');
                    } else {
                        currentTd.textContent = 'Unassigned';
                    }
                    tr.appendChild(currentTd);
                    // Assign to Case Worker column
                    const assignTd = document.createElement('td');
                    if (assigned) {
                        // Show Unassign button if already assigned
                        const unassignBtn = document.createElement('button');
                        unassignBtn.textContent = 'Unassign';
                        unassignBtn.addEventListener('click', function(ev) {
                            ev.preventDefault();
                            console.log('[DEBUG] Unassign button clicked for case:', c.id);
                            const token = getToken();
                            console.log('[DEBUG] Will send POST to /api/cases/' + c.id + '/unassign with token:', token);
                            fetch(`/api/cases/${encodeURIComponent(c.id)}/unassign`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': 'Bearer ' + token
                                }
                            })
                            .then(r => {
                                console.log('[DEBUG] Unassign response status:', r.status);
                                return r.json();
                            })
                            .then(result => {
                                console.log('[DEBUG] Unassign response data:', result);
                                if (result.success) {
                                    loadCases();
                                } else {
                                    alert(result.error || 'Failed to unassign');
                                }
                            })
                            .catch(err => {
                                console.error('[DEBUG] Unassign fetch error:', err);
                            });
                        });
                        assignTd.appendChild(unassignBtn);
                    } else {
                        // Show assign dropdown and button if unassigned
                        const select = document.createElement('select');
                        select.innerHTML = '<option value="">-- Select --</option>';
                        fetch('/api/users', {
                            headers: { 'Authorization': 'Bearer ' + getToken() }
                        })
                        .then(r => r.json())
                        .then(usersData => {
                            (usersData.users || []).filter(u => u.roles && u.roles.includes('case_worker')).forEach(u => {
                                const opt = document.createElement('option');
                                opt.value = u.email;
                                opt.textContent = u.name + ' (' + u.email + ')';
                                select.appendChild(opt);
                            });
                        });
                        const assignBtn = document.createElement('button');
                        assignBtn.textContent = 'Assign';
                        assignBtn.addEventListener('click', function(ev) {
                            ev.preventDefault();
                            const email = select.value;
                            if (!email) return alert('Select a case worker');
                            fetch(`/api/cases/${encodeURIComponent(c.id)}/assign`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Bearer ' + token
                                },
                                body: JSON.stringify({ email })
                            })
                            .then(r => r.json())
                            .then(result => {
                                if (result.success) {
                                    showSection('clients');
                                    loadCases();
                                } else {
                                    alert(result.error || 'Failed to assign');
                                }
                            });
                        });
                        assignTd.appendChild(select);
                        assignTd.appendChild(assignBtn);
                    }
                    tr.appendChild(assignTd);
                    table.appendChild(tr);
                });
            });
        }

        // --- First Nations (Communities) List ---
        function loadFirstNations() {
            const token = getToken();
            fetch('/api/communities', {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(r => r.json())
            .then(data => {
                const list = data.communities || [];
                const ul = document.getElementById('firstNationsList');
                ul.innerHTML = '';
                if (list.length === 0) {
                    const li = document.createElement('li');
                    li.textContent = 'No First Nations found.';
                    ul.appendChild(li);
                    return;
                }
                // Sort alphabetically by name
                list.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                list.forEach(c => {
                    const li = document.createElement('li');
                    li.className = 'fn-list-item';
                    li.style.cursor = 'pointer';
                    li.style.color = '#6fcf6f';
                    li.style.fontFamily = 'inherit';
                    li.style.fontSize = '1.08rem';
                    li.style.marginBottom = '0.5em';
                    li.textContent = c.name;
                    // Details box (hidden by default)
                    const details = document.createElement('div');
                    details.className = 'fn-details';
                    details.style.display = 'none';
                    details.style.border = '1px solid #ccc';
                    details.style.background = '#111';
                    details.style.color = '#fff';
                    details.style.padding = '10px';
                    details.style.marginTop = '5px';
                    details.style.borderRadius = '5px';
                    details.style.maxWidth = '400px';
                    details.innerHTML =
                      (c.address ? `<div><strong>Address:</strong> ${c.address}</div>` : '') +
                      (c.phone ? `<div><strong>Phone:</strong> ${c.phone}</div>` : '') +
                      (c.fax ? `<div><strong>Fax:</strong> ${c.fax}</div>` : '') +
                      (c.latitude && c.longitude ? `<div><strong>Lat/Lon:</strong> ${c.latitude}, ${c.longitude}</div>` : '');
                    // Toggle details on click
                    li.addEventListener('click', function() {
                        // Hide all other open details and reset color
                        document.querySelectorAll('.fn-details').forEach(d => {
                            if (d !== details) d.style.display = 'none';
                        });
                        document.querySelectorAll('.fn-list-item').forEach(n => {
                            n.style.color = '#6fcf6f';
                            n.style.textShadow = '';
                        });
                        if (details.style.display === 'block') {
                            details.style.display = 'none';
                            li.style.color = '#6fcf6f';
                            li.style.textShadow = '';
                        } else {
                            details.style.display = 'block';
                            li.style.color = '#39ff14';
                            li.style.textShadow = '0 0 2px #39ff14, 0 0 4px #222';
                        }
                    });
                    li.appendChild(details);
                    ul.appendChild(li);
                });
            });
        }

        // --- Organization Management ---
        function loadOrganizations() {
            const token = getToken();
            fetch('/api/organizations', {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(r => r.json())
            .then(data => {
                const list = data.organizations || [];
                const container = document.getElementById('organizationList');
                container.innerHTML = '';
                list.forEach(org => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'org-list-item';
                    // Name clickable, styled like First Nations list
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'org-name';
                    nameSpan.textContent = org.name;
                    nameSpan.style.cursor = 'pointer';
                    nameSpan.style.display = 'block';
                    nameSpan.style.marginBottom = '0.5em';
                    nameSpan.style.fontWeight = 'bold';
                    // Details box (hidden by default)
                    const details = document.createElement('div');
                    details.className = 'org-details';
                    details.style.display = 'none';
                    details.style.border = '1px solid #ccc';
                    details.style.background = '#111';
                    details.style.color = '#fff';
                    details.style.padding = '10px';
                    details.style.marginTop = '5px';
                    details.style.borderRadius = '5px';
                    details.style.maxWidth = '400px';
                    details.innerHTML =
                      (org.phone ? `<div><strong>Phone:</strong> ${org.phone}</div>` : '') +
                      (org.contact ? `<div><strong>Contact:</strong> ${org.contact}</div>` : '') +
                      (org.address ? `<div><strong>Address:</strong> ${org.address}</div>` : '') +
                      (org.website ? `<div><strong>Website:</strong> <a href="${org.website}" target="_blank">${org.website}</a></div>` : '');
                    // Delete button
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.className = 'delete-btn';
                    delBtn.style.background = '#23272b';
                    delBtn.style.color = '#6fcf6f';
                    delBtn.style.border = '1px solid #3a3f47';
                    delBtn.style.padding = '5px 10px';
                    delBtn.style.borderRadius = '3px';
                    delBtn.style.cursor = 'pointer';
                    delBtn.style.marginTop = '10px';
                    delBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (confirm('Delete this organization?')) {
                            fetch('/api/organizations', {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Bearer ' + token
                                },
                                body: JSON.stringify({ name: org.name })
                            })
                            .then(r => r.json())
                            .then(() => loadOrganizations());
                        }
                    });
                    details.appendChild(delBtn);
                    // Toggle details on name click
                    nameSpan.addEventListener('click', function() {
                        // Hide all other open details and reset name color
                        document.querySelectorAll('.org-details').forEach(d => {
                            if (d !== details) d.style.display = 'none';
                        });
                        document.querySelectorAll('.org-name').forEach(n => {
                            n.style.color = '#6fcf6f';
                            n.style.textShadow = '';
                        });
                        // Toggle this one
                        if (details.style.display === 'block') {
                            details.style.display = 'none';
                            nameSpan.style.color = '#6fcf6f';
                            nameSpan.style.textShadow = '';
                        } else {
                            details.style.display = 'block';
                            nameSpan.style.color = '#39ff14';
                            nameSpan.style.textShadow = '0 0 2px #39ff14, 0 0 4px #222';
                        }
                    });
                    wrapper.appendChild(nameSpan);
                    wrapper.appendChild(details);
                    container.appendChild(wrapper);
                });
            });
        }
        document.getElementById('addOrganizationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const token = getToken();
            const name = document.getElementById('organizationName').value.trim();
            const contact = document.getElementById('organizationContact').value.trim();
            const phone = document.getElementById('organizationPhone').value.trim();
            if (!name) {
                alert('Name is required');
                return;
            }
            fetch('/api/organizations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify({ name, contact, phone })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    document.getElementById('addOrganizationForm').reset();
                    loadOrganizations();
                } else {
                    alert(result.error || 'Failed to add organization');
                }
            })
            .catch(err => {
                alert('Error submitting organization form: ' + err);
            });
        });
    });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Missing Persons App</title>
    <link rel="stylesheet" href="retro.css">
    <script>
    </script>
    <script src="navbar.js"></script>
    <script src="navbar-auth.js"></script>
</head>
<body>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Section toggling logic ---
        function showSection(section) {
            document.getElementById('users').style.display = 'none';
            document.getElementById('clients').style.display = 'none';
            document.getElementById('settings').style.display = 'none';
            document.getElementById(section).style.display = 'block';
            if (section === 'users') loadUsers();
            if (section === 'clients') loadCases();
            if (section === 'settings') {
                loadOrganizations();
                loadFirstNations();
            }
        }
        document.getElementById('showUsers').addEventListener('click', function(e) {
            e.preventDefault();
            showSection('users');
        });
        document.getElementById('showClients').addEventListener('click', function(e) {
                    
        fetch('/api/cases', {
            headers: { 'Authorization': 'Bearer ' + token }
        })
        .then(r => r.json())
        .then(data => {
            const cases = data.cases || [];
            const table = document.getElementById('casesTable').getElementsByTagName('tbody')[0];
            table.innerHTML = '';
            if (cases.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 3;
                td.textContent = 'No cases found.';
                tr.appendChild(td);
                table.appendChild(tr);
                return;
            }
            cases.forEach(c => {
                const tr = document.createElement('tr');
                // Name column
                const nameTd = document.createElement('td');
                nameTd.textContent = c.name || c.id || '(no name)';
                tr.appendChild(nameTd);
                // Current Case Worker / Unassign column
                const currentTd = document.createElement('td');
                let assigned = c.assignedTo && c.assignedTo.length > 0;
                if (assigned) {
                    currentTd.textContent = c.assignedTo.join(', ');
                } else {
                    currentTd.textContent = 'Unassigned';
                }
                tr.appendChild(currentTd);
                // Assign to Case Worker column
                const assignTd = document.createElement('td');
                if (assigned) {
                        // Show Unassign button if already assigned
                        const unassignBtn = document.createElement('button');
                        unassignBtn.textContent = 'Unassign';
                        unassignBtn.onclick = function(ev) {
                            ev.preventDefault();
                            console.log('[DEBUG] Unassign button clicked for case:', c.id);
                            const token = getToken();
                            console.log('[DEBUG] Will send POST to /api/cases/' + c.id + '/unassign with token:', token);
                            fetch(`/api/cases/${encodeURIComponent(c.id)}/unassign`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': 'Bearer ' + getToken()
                                }
                            })
                            .then(r => {
                                console.log('[DEBUG] Unassign response status:', r.status);
                                return r.json();
                            })
                            .then(result => {
                                console.log('[DEBUG] Unassign response data:', result);
                                if (result.success) {
                                    loadCases();
                                } else {
                                    alert(result.error || 'Failed to unassign');
                                }
                            })
                            .catch(err => {
                                console.error('[DEBUG] Unassign fetch error:', err);
                            });
                        };
                        assignTd.appendChild(unassignBtn);
                } else {
                    // Show assign dropdown and button if unassigned
                    const select = document.createElement('select');
                    select.innerHTML = '<option value="">-- Select --</option>';
                    fetch('/api/users', {
                        headers: { 'Authorization': 'Bearer ' + token }
                    })
                    .then(r => r.json())
                    .then(usersData => {
                        (usersData.users || []).filter(u => u.roles && u.roles.includes('case_worker')).forEach(u => {
                            const opt = document.createElement('option');
                            opt.value = u.email;
                            opt.textContent = u.name + ' (' + u.email + ')';
                            select.appendChild(opt);
                        });
                    });
                    const assignBtn = document.createElement('button');
                    assignBtn.textContent = 'Assign';
                    assignBtn.addEventListener('click', function(ev) {
                        ev.preventDefault();
                        const email = select.value;
                        if (!email) return alert('Select a case worker');
                        fetch(`/api/cases/${encodeURIComponent(c.id)}/assign`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': 'Bearer ' + token
                            },
                            body: JSON.stringify({ email })
                        })
                        .then(r => r.json())
                        .then(result => {
                            if (result.success) {
                                loadCases();
                            } else {
                                alert(result.error || 'Failed to assign');
                            }
                        });
                    });
                    assignTd.appendChild(select);
                    assignTd.appendChild(assignBtn);
                }
                tr.appendChild(assignTd);
                table.appendChild(tr);
            });
        });
    }
    // --- First Nations (Communities) List ---

