<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Offender News - Police RSS</title>
  <link rel="stylesheet" href="retro.css">
  <script src="navbar.js"></script>
  <script src="navbar-auth.js"></script>
  <script src="offender-news-menu.js"></script>
</head>
<body>
  <header style="position:relative;">
    <h1 style="text-align:center;">Offender News â€“ Police RSS</h1>
    <!-- Navigation will be injected here -->
  </header>
  <main>
    <!-- Offender News menu will be injected here -->

    <section>
      <button id="refreshPoliceRssButton">Refresh Police RSS</button>
      <span id="policeRssStatusMessage"></span>
    </section>

    <section id="policeRssContainer"></section>
  </main>

  <script>
    function getToken() {
      const match = document.cookie.match(/(^| )token=([^;]+)/);
      if (match) return match[2];
      return (
        localStorage.getItem('token') ||
        sessionStorage.getItem('token') ||
        ''
      );
    }

    function escapeHtml(str) {
      return (str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatDate(value) {
      if (!value) return '';
      try {
        const date = new Date(value);
        if (!isNaN(date.getTime())) {
          return date.toLocaleString();
        }
      } catch (e) {
        // ignore
      }
      return value;
    }

    async function fetchPoliceRss() {
      const token = getToken();
      const statusEl = document.getElementById('policeRssStatusMessage');
      if (!token) {
        statusEl.textContent = 'Authentication required. Please log in again.';
        return;
      }

      statusEl.textContent = 'Loading Police RSS...';

      try {
        const res = await fetch('/api/offender-news/police-rss', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) {
          throw new Error('Failed to load Police RSS');
        }
        const data = await res.json();
        renderPoliceItems(data.items || []);
        statusEl.textContent = 'Loaded ' + (data.items?.length || 0) + ' item(s).';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'Failed to load Police RSS.';
      }
    }

    function renderPoliceItems(items) {
      const container = document.getElementById('policeRssContainer');
      container.innerHTML = '';

      if (!items.length) {
        container.textContent = 'No Police RSS items available.';
        return;
      }

      items.forEach(item => {
        const article = document.createElement('article');
        const title = escapeHtml(item.title || '(no title)');
        const link = item.link || '';
        const date = formatDate(item.pubDate || item.publishedAt);

        article.innerHTML = `
          <h3>${link ? `<a href="${escapeHtml(link)}" target="_blank" rel="noopener noreferrer">${title}</a>` : title}</h3>
          ${date ? `<div>${escapeHtml(date)}</div>` : ''}
        `;

        container.appendChild(article);
      });
    }

    document.getElementById('refreshPoliceRssButton')
      .addEventListener('click', fetchPoliceRss);

    // Load on page open
    fetchPoliceRss();
  </script>
</body>
</html>


