<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Blast - Missing Persons App</title>
    <link rel="stylesheet" href="retro.css">
    <script src="navbar.js"></script>
    <script src="navbar-auth.js"></script>
    <script src="sms-menu.js"></script>
    <style>
        #statusMessage {
            margin-top: 1rem;
            padding: 0.8rem;
            border-radius: 4px;
            font-weight: 600;
            white-space: pre-wrap;
            word-break: break-word;
        }
        #statusMessage.error {
            color: #ff8080;
            background: rgba(255, 128, 128, 0.1);
            border: 1px solid #ff8080;
        }
        #statusMessage.success {
            color: #6fcf6f;
            background: rgba(111, 207, 111, 0.1);
            border: 1px solid #6fcf6f;
        }
        #statusMessage.info {
            color: #6fcf6f;
        }
        #statusMessage.warning {
            color: #ffaa00;
            background: rgba(255, 170, 0, 0.1);
            border: 1px solid #ffaa00;
        }
        .client-count {
            margin: 1rem 0;
            padding: 0.8rem;
            background: #23272b;
            border: 1px solid #333;
            border-radius: 4px;
        }
        #progressSection {
            margin-top: 1rem;
            padding: 1rem;
            background: #23272b;
            border: 1px solid #333;
            border-radius: 4px;
            display: none;
        }
        #progressBar {
            width: 100%;
            height: 24px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            margin: 0.5rem 0;
        }
        #progressBarFill {
            height: 100%;
            background: #6fcf6f;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: bold;
            font-size: 12px;
        }
        #progressText {
            margin-top: 0.5rem;
            font-size: 0.9em;
        }
        textarea {
            width: 100%;
            min-height: 150px;
            max-width: 100%;
            box-sizing: border-box;
        }
        .preview-section {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #23272b;
            border: 1px solid #333;
            border-radius: 4px;
        }
        input[type="text"] {
            width: 100%;
            max-width: 500px;
            box-sizing: border-box;
        }
        button[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <header style="position:relative;">
        <h1 style="text-align:center;">Email Blast</h1>
        <!-- Navigation will be injected here -->
    </header>
    <main>
        <script>
            // Check if user is admin, redirect if not
            function getToken() {
                const match = document.cookie.match(/(^| )token=([^;]+)/);
                if (match) return match[2];
                return localStorage.getItem('token') || sessionStorage.getItem('token') || '';
            }
            function isAdmin() {
                try {
                    const token = getToken();
                    if (!token) return false;
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    let roles = payload.roles || payload.groups || payload.roles_claim || [];
                    if (!Array.isArray(roles)) roles = [roles];
                    return roles.includes('admin');
                } catch (e) {
                    return false;
                }
            }
            if (!isAdmin()) {
                window.location.href = 'allcases.html';
            }
        </script>
        <!-- SMS menu will be injected here -->
        <h2>Send Email to All Clients</h2>
        <p>This will send an email message to all clients who have registered their email address.</p>
        
        <div class="client-count" id="clientCount">
            <strong>Loading client count...</strong>
        </div>

        <form id="emailBlastForm">
            <div class="form-row">
                <label for="subjectText">Subject:</label>
                <input type="text" id="subjectText" name="subject" required placeholder="Enter email subject...">
            </div>
            <div class="form-row">
                <label for="messageText">Message:</label>
                <textarea id="messageText" name="message" required placeholder="Enter your email message here..."></textarea>
            </div>
            
            <div class="preview-section" id="previewSection" style="display:none;">
                <h3>Preview</h3>
                <p><strong>Subject:</strong> <span id="previewSubject"></span></p>
                <p id="previewText" style="white-space:pre-wrap;word-break:break-word;"></p>
            </div>

            <div class="form-row">
                <button type="submit" id="sendButton">Send Email to All Clients</button>
                <button type="button" id="previewButton">Preview</button>
            </div>
        </form>

        <div id="statusMessage"></div>
        
        <div id="progressSection">
            <h3>Email Blast Progress</h3>
            <div id="progressBar">
                <div id="progressBarFill" style="width: 0%;">0%</div>
            </div>
            <div id="progressText">Initializing...</div>
        </div>
    </main>

    <script>
        let clientCount = 0;
        let clientList = [];

        function getToken() {
            const match = document.cookie.match(/(^| )token=([^;]+)/);
            if (match) return match[2];
            return localStorage.getItem('token') || sessionStorage.getItem('token') || '';
        }

        function setStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message || '';
            statusEl.className = type || '';
        }

        async function loadClientCount() {
            try {
                const response = await fetch('/api/applicants/with-email-addresses', {
                    headers: {
                        'Authorization': 'Bearer ' + getToken()
                    }
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Unknown error', details: 'Could not parse error response' }));
                    const errorMsg = errorData.error || `HTTP ${response.status}: ${response.statusText}`;
                    const details = errorData.details ? ` (${errorData.details})` : '';
                    throw new Error(errorMsg + details);
                }
                const data = await response.json();
                clientList = data.applicants || [];
                clientCount = clientList.length;
                const countEl = document.getElementById('clientCount');
                if (clientCount === 0) {
                    countEl.innerHTML = '<strong>No clients with email addresses found.</strong>';
                } else {
                    countEl.innerHTML = `<strong>${clientCount} client${clientCount === 1 ? '' : 's'} with email address${clientCount === 1 ? '' : 'es'} will receive this message.</strong>`;
                }
            } catch (err) {
                console.error('Failed to load client count:', err);
                setStatus('Failed to load client count: ' + (err.message || err), 'error');
            }
        }

        function showPreview() {
            const subjectText = document.getElementById('subjectText').value.trim();
            const messageText = document.getElementById('messageText').value.trim();
            if (!subjectText || !messageText) {
                setStatus('Please enter both subject and message to preview.', 'error');
                return;
            }
            const previewSection = document.getElementById('previewSection');
            const previewSubject = document.getElementById('previewSubject');
            const previewText = document.getElementById('previewText');
            previewSubject.textContent = subjectText;
            previewText.textContent = messageText;
            previewSection.style.display = 'block';
            setStatus('', '');
        }

        let progressPollInterval = null;
        let currentJobId = null;

        function updateProgressDisplay(progress) {
            const progressSection = document.getElementById('progressSection');
            const progressBarFill = document.getElementById('progressBarFill');
            const progressText = document.getElementById('progressText');
            
            if (!progress) {
                progressSection.style.display = 'none';
                return;
            }
            
            progressSection.style.display = 'block';
            
            const total = progress.total || 0;
            const current = progress.current || 0;
            const sent = progress.sent || 0;
            const failed = progress.failed || 0;
            const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
            
            progressBarFill.style.width = percentage + '%';
            progressBarFill.textContent = percentage + '%';
            
            let statusText = '';
            if (progress.status === 'starting') {
                statusText = 'Initializing email blast...';
            } else if (progress.status === 'sending') {
                statusText = `Sending: ${sent} sent, ${failed} failed (${current}/${total} total)`;
            } else if (progress.status === 'completed') {
                statusText = `Completed: ${sent} sent, ${failed} failed out of ${total} total`;
                if (progress.errors && progress.errors.length > 0) {
                    statusText += `\n\nLast errors:\n${progress.errors.slice(-5).join('\n')}`;
                }
            } else if (progress.status === 'error') {
                statusText = `Error: ${progress.error || 'Unknown error'}`;
            }
            
            progressText.textContent = statusText;
        }

        function stopProgressPolling() {
            if (progressPollInterval) {
                clearInterval(progressPollInterval);
                progressPollInterval = null;
            }
            currentJobId = null;
        }

        async function pollProgress(jobId) {
            try {
                const response = await fetch(`/api/email-blast/progress/${jobId}`, {
                    headers: {
                        'Authorization': 'Bearer ' + getToken()
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        // Job not found, might be completed and cleaned up
                        stopProgressPolling();
                        return;
                    }
                    throw new Error('Failed to fetch progress');
                }
                
                const progress = await response.json();
                updateProgressDisplay(progress);
                
                // Stop polling if completed or error
                if (progress.status === 'completed' || progress.status === 'error') {
                    stopProgressPolling();
                    
                    // Re-enable send button
                    const sendButton = document.getElementById('sendButton');
                    sendButton.disabled = false;
                    sendButton.textContent = 'Send Email to All Clients';
                    
                    // Show final status
                    let statusMsg = `Successfully sent email to ${progress.sent || 0} client${progress.sent === 1 ? '' : 's'}.`;
                    if (progress.failed) {
                        statusMsg += ` ${progress.failed} failed.`;
                    }
                    if (progress.errors && progress.errors.length > 0 && progress.errors.length <= 10) {
                        statusMsg += '\n\nErrors:\n' + progress.errors.join('\n');
                    } else if (progress.errors && progress.errors.length > 10) {
                        statusMsg += `\n\n${progress.errors.length} errors occurred. Showing last 10:\n` + progress.errors.slice(-10).join('\n');
                    }
                    
                    let statusType = 'success';
                    if (progress.failed > 0 || progress.status === 'error') {
                        statusType = 'error';
                    }
                    setStatus(statusMsg, statusType);
                    
                    // Reset form
                    document.getElementById('emailBlastForm').reset();
                    document.getElementById('previewSection').style.display = 'none';
                }
            } catch (err) {
                console.error('Failed to poll progress:', err);
            }
        }

        async function sendEmailBlast() {
            const subjectText = document.getElementById('subjectText').value.trim();
            const messageText = document.getElementById('messageText').value.trim();
            if (!subjectText || !messageText) {
                setStatus('Please enter both subject and message.', 'error');
                return;
            }
            if (clientCount === 0) {
                setStatus('No clients with email addresses found.', 'error');
                return;
            }

            const sendButton = document.getElementById('sendButton');
            sendButton.disabled = true;
            sendButton.textContent = 'Sending...';

            // Hide previous status and show progress
            setStatus('', '');
            document.getElementById('progressSection').style.display = 'block';
            updateProgressDisplay({ status: 'starting', total: clientCount, current: 0, sent: 0, failed: 0 });

            try {
                const response = await fetch('/api/email-blast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getToken()
                    },
                    body: JSON.stringify({
                        subject: subjectText,
                        message: messageText
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ error: 'Failed to send email blast', details: 'Could not parse error response' }));
                    const errorMsg = errorData.error || 'Failed to send email blast';
                    const details = errorData.details ? ` (${errorData.details})` : '';
                    throw new Error(errorMsg + details);
                }

                const data = await response.json();
                
                if (data.jobId) {
                    // Start polling for progress
                    currentJobId = data.jobId;
                    progressPollInterval = setInterval(() => pollProgress(data.jobId), 1000); // Poll every second
                    setStatus('Email blast started. Progress will be shown below.', 'info');
                } else {
                    // Fallback if no jobId (shouldn't happen with new code)
                    setStatus('Email blast started but progress tracking unavailable.', 'info');
                }
            } catch (err) {
                console.error('Failed to send email blast:', err);
                setStatus('Failed to send email blast: ' + err.message, 'error');
                document.getElementById('progressSection').style.display = 'none';
                stopProgressPolling();
            } finally {
                // Don't re-enable button until job is complete (handled in pollProgress)
            }
        }
        
        // Clean up polling on page unload
        window.addEventListener('beforeunload', () => {
            stopProgressPolling();
        });

        document.getElementById('previewButton').addEventListener('click', showPreview);
        document.getElementById('emailBlastForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (confirm(`Are you sure you want to send this email to ${clientCount} client${clientCount === 1 ? '' : 's'}?`)) {
                sendEmailBlast();
            }
        });

        // Load client count on page load
        loadClientCount();
    </script>
</body>
</html>

