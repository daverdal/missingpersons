<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Settings - Admin</title>
    <link rel="stylesheet" href="retro.css">
    <script src="auth-check.js"></script>
    <script src="navbar.js"></script>
    <script src="navbar-auth.js"></script>
    <style>
        .form-group {
            margin-bottom: 1.5rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="number"] {
            width: 100%;
            max-width: 500px;
            padding: 0.5rem;
            box-sizing: border-box;
        }
        .help-text {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 0.25rem;
        }
        #statusMessage {
            margin-top: 1rem;
            padding: 0.8rem;
            border-radius: 4px;
            font-weight: 600;
        }
        #statusMessage.success {
            color: #6fcf6f;
            background: rgba(111, 207, 111, 0.1);
            border: 1px solid #6fcf6f;
        }
        #statusMessage.error {
            color: #ff8080;
            background: rgba(255, 128, 128, 0.1);
            border: 1px solid #ff8080;
        }
        .current-settings {
            background: #23272b;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 2rem;
        }
        .current-settings h3 {
            margin-top: 0;
        }
        .current-settings p {
            margin: 0.5rem 0;
        }
    </style>
</head>
<body>
    <header style="position:relative;">
        <h1 style="text-align:center;">Email Settings</h1>
        <!-- Navigation will be injected here -->
    </header>
    <main>
        <h2>Email Configuration</h2>
        <p>Configure SMTP settings for sending emails (used by Email Blast feature).</p>
        <p><strong>Note:</strong> These settings are stored in the database. You can also set them in your <code>.env</code> file, but database settings take precedence.</p>
        
        <div class="current-settings" id="currentSettings">
            <h3>Current Settings</h3>
            <p>Loading...</p>
        </div>

        <form id="emailSettingsForm">
            <div class="form-group">
                <label for="smtpHost">SMTP Host</label>
                <input type="text" id="smtpHost" placeholder="smtp.gmail.com">
                <div class="help-text">The SMTP server hostname (e.g., smtp.gmail.com for Gmail). Leave empty to keep current value.</div>
            </div>

            <div class="form-group">
                <label for="smtpPort">SMTP Port</label>
                <input type="number" id="smtpPort" placeholder="587">
                <div class="help-text">SMTP port (587 for TLS, 465 for SSL). Leave empty to keep current value.</div>
            </div>

            <div class="form-group">
                <label for="smtpSecure">Use SSL/TLS</label>
                <select id="smtpSecure" style="padding: 0.5rem; max-width: 500px;">
                    <option value="">-- Keep current value --</option>
                    <option value="false">TLS (port 587)</option>
                    <option value="true">SSL (port 465)</option>
                </select>
                <div class="help-text">Use SSL for secure connection (typically for port 465). Select "-- Keep current value --" to leave unchanged.</div>
            </div>

            <div class="form-group">
                <label for="smtpUser">SMTP Username (Email Address)</label>
                <input type="email" id="smtpUser" placeholder="your-email@gmail.com" autocomplete="username">
                <div class="help-text">Your email address used for SMTP authentication. Leave empty to keep current value.</div>
            </div>

            <div class="form-group">
                <label for="smtpPass">SMTP Password</label>
                <input type="password" id="smtpPass" placeholder="Enter new password (leave empty to keep current)" autocomplete="new-password">
                <div class="help-text">Your email password or app-specific password (for Gmail, use an App Password). Leave empty to keep current password.</div>
            </div>

            <div class="form-group">
                <label for="emailFrom">From Email Address</label>
                <input type="email" id="emailFrom" name="from-addr" placeholder="noreply@yourdomain.com" autocomplete="off" data-lpignore="true" data-form-type="other">
                <div class="help-text">The "from" address that recipients will see (e.g., noreply@yourdomain.com). <strong>Note:</strong> When using Gmail, the authenticated Gmail account address will always be shown, regardless of this setting. Leave empty to keep current value.</div>
            </div>

            <div class="form-group">
                <label for="emailFromName">From Display Name (Optional)</label>
                <input type="text" id="emailFromName" name="from-name" placeholder="Missing Persons System" autocomplete="off" data-lpignore="true" data-form-type="other">
                <div class="help-text">Optional: Display name that appears before the email address. If set, emails will show as "Display Name &lt;email@address.com&gt;". <strong>Note:</strong> With Gmail, the email address will always be your authenticated Gmail account, but you can customize the display name.</div>
            </div>

            <div class="form-group">
                <label for="emailReplyTo">Reply-To Address (Optional)</label>
                <input type="email" id="emailReplyTo" name="reply-to-addr" placeholder="noreply+blast@yourdomain.com" autocomplete="off" data-lpignore="true" data-form-type="other">
                <div class="help-text">Optional: Separate address for replies (when recipients click "Reply"). Note: Bounce-back emails go to the "From Address" above, not this field. To redirect bounces, use a separate email account as the "From Address".</div>
            </div>
            
            <div style="background: #2a2f35; border: 1px solid #444; border-radius: 4px; padding: 1rem; margin-top: 1.5rem;">
                <h3 style="margin-top: 0;">About Email Sending with Gmail</h3>
                <p><strong>Gmail Limitation:</strong> When using Gmail SMTP, Gmail will always show the authenticated Gmail account's email address in the "From" field, regardless of what you set in "From Email Address" above. This is a Gmail security feature to prevent email spoofing.</p>
                <p><strong>What you can customize:</strong> You can set a "From Display Name" to show a friendly name (e.g., "Missing Persons System"), but the email address will still be your Gmail account.</p>
                <p><strong>To hide the Gmail address:</strong> You would need to either:
                    <ul style="margin-left: 1.5rem; margin-top: 0.5rem;">
                        <li>Set up Gmail's "Send mail as" feature for the address you want to use (requires verification in Gmail settings)</li>
                        <li>Use a different email service that allows sending from any address</li>
                        <li>Use a dedicated Gmail account for email blasts (e.g., <code>missingpersons-blasts@gmail.com</code>)</li>
                    </ul>
                </p>
                <p><strong>About Bounce-Back Emails:</strong> Bounce-back emails go to the authenticated Gmail account, not the Reply-To address. The system automatically filters out bounce-back emails from the Offender News inbox, so they won't trigger SMS alerts.</p>
            </div>

            <button type="submit" style="padding: 0.6rem 1.2rem; font-size: 1em;">Save Email Settings</button>
            <span id="statusMessage"></span>
        </form>
    </main>

    <script>
        function getToken() {
            const match = document.cookie.match(/(^| )token=([^;]+)/);
            if (match) return match[2];
            return localStorage.getItem('token') || sessionStorage.getItem('token') || '';
        }

        function isAdmin() {
            try {
                const token = getToken();
                if (!token) return false;
                const payload = JSON.parse(atob(token.split('.')[1]));
                let roles = payload.roles || payload.groups || payload.roles_claim || [];
                if (!Array.isArray(roles)) roles = [roles];
                return roles.includes('admin');
            } catch (e) {
                return false;
            }
        }

        function setStatus(message, type) {
            const statusEl = document.getElementById('statusMessage');
            statusEl.textContent = message || '';
            statusEl.className = type || '';
        }

        function loadCurrentSettings() {
            fetch('/api/email-settings', {
                headers: {
                    'Authorization': 'Bearer ' + getToken()
                }
            })
            .then(r => r.json())
            .then(data => {
                const settings = data.settings || {};
                const effective = data.effective || {};
                const source = data.source || 'unknown';
                const currentDiv = document.getElementById('currentSettings');
                
                // Show effective settings (what's actually being used)
                const displaySettings = effective && Object.keys(effective).length > 0 ? effective : settings;
                const sourceText = source === 'database' ? 'Database' : 
                                  source === 'offender_news_config' ? 'Offender News Config (Gmail)' : 
                                  'Environment Variables';
                
                if (Object.keys(displaySettings).length === 0) {
                    currentDiv.innerHTML = '<h3>Current Settings</h3><p>No email settings configured. Email blast will not work until settings are configured.</p>';
                } else {
                    currentDiv.innerHTML = `
                        <h3>Current Settings (Effective)</h3>
                        <p style="font-size: 0.9em; color: #aaa; margin-bottom: 1rem;"><em>Source: ${sourceText}</em></p>
                        <p><strong>SMTP Host:</strong> ${displaySettings.smtpHost || '(not set)'}</p>
                        <p><strong>SMTP Port:</strong> ${displaySettings.smtpPort || '(not set)'}</p>
                        <p><strong>Use SSL:</strong> ${displaySettings.smtpSecure === true ? 'Yes' : 'No'}</p>
                        <p><strong>SMTP Username:</strong> ${displaySettings.smtpUser || '(not set)'}</p>
                        <p><strong>From Address:</strong> ${displaySettings.emailFrom || '(not set)'}</p>
                        <p><strong>From Display Name:</strong> ${displaySettings.emailFromName || '(not set)'}</p>
                        <p><strong>Reply-To:</strong> ${displaySettings.emailReplyTo || '(not set)'}</p>
                        ${source !== 'database' && Object.keys(settings).length > 0 ? 
                          '<p style="margin-top: 1rem; font-size: 0.9em; color: #aaa;"><em>Note: Some settings are stored in the database and will be merged with the above.</em></p>' : ''}
                    `;
                }

                // Populate form with stored settings (from database) - these are what can be edited
                // Use effective settings as fallback if stored settings are empty
                const formSettings = Object.keys(settings).length > 0 ? settings : effective;
                
                if (formSettings.smtpHost) document.getElementById('smtpHost').value = formSettings.smtpHost;
                if (formSettings.smtpPort) document.getElementById('smtpPort').value = formSettings.smtpPort;
                if (formSettings.smtpSecure !== undefined) document.getElementById('smtpSecure').value = String(formSettings.smtpSecure);
                if (formSettings.smtpUser) document.getElementById('smtpUser').value = formSettings.smtpUser;
                if (formSettings.emailFrom) {
                    const emailFromField = document.getElementById('emailFrom');
                    emailFromField.value = formSettings.emailFrom;
                    emailFromField._originalValue = formSettings.emailFrom;
                }
                if (formSettings.emailFromName) {
                    const emailFromNameField = document.getElementById('emailFromName');
                    emailFromNameField.value = formSettings.emailFromName;
                    emailFromNameField._originalValue = formSettings.emailFromName;
                }
                if (formSettings.emailReplyTo) {
                    const emailReplyToField = document.getElementById('emailReplyTo');
                    emailReplyToField.value = formSettings.emailReplyTo;
                    emailReplyToField._originalValue = formSettings.emailReplyTo;
                }
                // Don't populate password for security
                
                // Update global original values after loading
                emailFromOriginal = document.getElementById('emailFrom').value;
                emailFromNameOriginal = document.getElementById('emailFromName').value;
                emailReplyToOriginal = document.getElementById('emailReplyTo').value;
            })
            .catch(err => {
                console.error('Failed to load email settings:', err);
                setStatus('Failed to load current settings.', 'error');
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (!isAdmin()) {
                window.location.href = 'allcases.html';
                return;
            }

            // Prevent browser autofill from copying values between email fields
            const emailFromField = document.getElementById('emailFrom');
            const emailFromNameField = document.getElementById('emailFromName');
            const emailReplyToField = document.getElementById('emailReplyTo');

            // Function to store current values as originals
            function storeOriginalValues() {
                emailFromOriginal = emailFromField.value;
                emailFromNameOriginal = emailFromNameField.value;
                emailReplyToOriginal = emailReplyToField.value;
            }

            // Store initial values
            storeOriginalValues();

            // Monitor for unwanted autofill changes using input events
            [emailFromField, emailFromNameField, emailReplyToField].forEach(field => {
                // Watch for input events to detect autofill
                field.addEventListener('input', function(e) {
                    const activeField = document.activeElement;
                    // If user is typing in one field, prevent others from changing
                    if (activeField === field) {
                        // User is actively typing in this field - update original for this field only
                        if (field === emailFromField) {
                            emailFromOriginal = field.value;
                        } else if (field === emailFromNameField) {
                            emailFromNameOriginal = field.value;
                        } else if (field === emailReplyToField) {
                            emailReplyToOriginal = field.value;
                        }
                    } else {
                        // This field changed but user is typing in another field - might be autofill
                        // Restore the value if it doesn't match the original
                        if (field === emailFromField && field.value !== emailFromOriginal) {
                            setTimeout(() => {
                                if (document.activeElement !== emailFromField) {
                                    field.value = emailFromOriginal;
                                }
                            }, 10);
                        } else if (field === emailFromNameField && field.value !== emailFromNameOriginal) {
                            setTimeout(() => {
                                if (document.activeElement !== emailFromNameField) {
                                    field.value = emailFromNameOriginal;
                                }
                            }, 10);
                        } else if (field === emailReplyToField && field.value !== emailReplyToOriginal) {
                            setTimeout(() => {
                                if (document.activeElement !== emailReplyToField) {
                                    field.value = emailReplyToOriginal;
                                }
                            }, 10);
                        }
                    }
                });

                // Update original when field loses focus (user finished editing)
                field.addEventListener('blur', function() {
                    storeOriginalValues();
                });

                // Store values when field gets focus
                field.addEventListener('focus', function() {
                    storeOriginalValues();
                });
            });

            loadCurrentSettings();

            const form = document.getElementById('emailSettingsForm');
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                setStatus('', '');

                // Get form values - only include fields that have values (for partial updates)
                const settings = {};
                const smtpHostVal = document.getElementById('smtpHost').value.trim();
                const smtpPortVal = document.getElementById('smtpPort').value.trim();
                const smtpSecureVal = document.getElementById('smtpSecure').value;
                const smtpUserVal = document.getElementById('smtpUser').value.trim();
                const smtpPassVal = document.getElementById('smtpPass').value.trim();
                const emailFromVal = document.getElementById('emailFrom').value.trim();
                const emailFromNameVal = document.getElementById('emailFromName').value.trim();
                const emailReplyToVal = document.getElementById('emailReplyTo').value.trim();

                // Only include fields that have values (for partial updates)
                if (smtpHostVal) settings.smtpHost = smtpHostVal;
                if (smtpPortVal) {
                    const portNum = parseInt(smtpPortVal, 10);
                    if (isNaN(portNum) || portNum < 1 || portNum > 65535) {
                        setStatus('SMTP Port must be a valid port number (1-65535).', 'error');
                        return;
                    }
                    settings.smtpPort = portNum;
                }
                if (smtpSecureVal !== '') settings.smtpSecure = smtpSecureVal;
                if (smtpUserVal) settings.smtpUser = smtpUserVal;
                if (smtpPassVal) settings.smtpPass = smtpPassVal;
                if (emailFromVal) settings.emailFrom = emailFromVal;
                if (emailFromNameVal) settings.emailFromName = emailFromNameVal;
                if (emailReplyToVal) settings.emailReplyTo = emailReplyToVal;
                else if (emailReplyToVal === '') settings.emailReplyTo = null; // Allow clearing reply-to

                // Check if at least one field is being updated
                if (Object.keys(settings).length === 0) {
                    setStatus('Please fill in at least one field to update.', 'error');
                    return;
                }
                

                fetch('/api/email-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + getToken()
                    },
                    body: JSON.stringify(settings)
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        setStatus('Email settings saved successfully!', 'success');
                        // Clear password field for security
                        document.getElementById('smtpPass').value = '';
                        // Reload current settings to show updated values
                        loadCurrentSettings();
                    } else {
                        setStatus('Failed to save settings: ' + (data.error || 'Unknown error'), 'error');
                    }
                })
                .catch(err => {
                    console.error('Failed to save email settings:', err);
                    setStatus('Failed to save settings: ' + err.message, 'error');
                });
            });
        });
    </script>
</body>
</html>

