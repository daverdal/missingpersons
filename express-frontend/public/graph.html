<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Neo4j Graph Visualization</title>
  <link rel="stylesheet" href="retro.css">
  <script src="navbar.js"></script>
  <script src="navbar-auth.js"></script>
  <style>
    #viz {
      width: 1000px;
      height: 600px;
      background: #111;
      margin: 40px auto 0 auto;
      border-radius: 8px;
      box-shadow: 0 0 24px #000a;
      padding: 0;
    }
    .retro-box {
      width: 1100px;
      margin: 40px auto 0 auto;
      background: #181818;
      border-radius: 8px;
      box-shadow: 0 0 24px #000a;
      padding: 32px 40px 40px 40px;
      color: #6fcf6f;
      font-family: 'Fira Mono', 'Consolas', 'Menlo', monospace;
    }
    .retro-link {
      color: #4fa3ff;
      text-decoration: none;
      font-weight: bold;
      margin-right: 32px;
    }
    .retro-link:visited {
      color: #4fa3ff;
    }
  </style>
  <!-- vis.js CDN for network visualization -->
  <script src="https://cdn.jsdelivr.net/npm/vis-network@9.1.9/dist/vis-network.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/vis-network@9.1.9/dist/vis-network.min.css" rel="stylesheet" />
</head>
<body>
  <header>
    <h1 style="text-align:center;">Missing Persons Case Management</h1>
    <!-- Navigation will be injected here by navbar.js -->
  </header>
  <div class="retro-box">
    <div style="margin-bottom: 24px; display: flex; justify-content: center;">
      <div style="background: #222; border-radius: 8px; padding: 16px 32px; display: flex; gap: 32px; align-items: center; box-shadow: 0 2px 8px #0007;">
        <span style="display: flex; align-items: center; gap: 8px;"><span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#4fa3ff;"></span> User</span>
        <span style="display: flex; align-items: center; gap: 8px;"><span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#f7c873;"></span> Applicant</span>
        <span style="display: flex; align-items: center; gap: 8px;"><span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#e74c3c;"></span> Loved One</span>
        <span style="display: flex; align-items: center; gap: 8px;"><span style="display:inline-block;width:20px;height:20px;border-radius:50%;background:#b983ff;"></span> Community</span>
      </div>
    </div>
    <div id="viz"></div>
  </div>
  <script>
    // Cypher query for the graph
    const cypher = `MATCH (u:User)-[r:ASSIGNED_TO]->(a:Applicant)
OPTIONAL MATCH (a)-[rel:RELATED_TO]->(l:LovedOne)
RETURN u, r, a, rel, l LIMIT 100`;

    async function fetchGraph() {
      // Get token from cookie
      const match = document.cookie.match(/(^| )token=([^;]+)/);
      const token = match ? match[2] : '';
      try {
        console.log('[fetchGraph] Sending request with cypher:', cypher);
        console.log('[fetchGraph] Token present:', !!token);
        const res = await fetch('/api/graph-cypher', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify({ cypher })
        });
        console.log('[fetchGraph] Response status:', res.status, res.statusText);
        if (!res.ok) {
          const error = await res.json();
          console.error('[fetchGraph] Error response:', error);
          throw new Error(error.error || `HTTP ${res.status}: ${res.statusText}`);
        }
        const data = await res.json();
        console.log('[fetchGraph] Received data:', { nodes: data.nodes?.length || 0, relationships: data.relationships?.length || 0 });
        return data;
      } catch (err) {
        console.error('[fetchGraph] Failed to fetch graph:', err);
        throw err;
      }
    }

    function nodeLabel(node) {
  if (!node._labels) return node.name || node.id || '';
  if (node._labels.includes('User')) return `üë§ ${node.name}`;
  if (node._labels.includes('Applicant')) return `üìÅ ${node.name}`;
  if (node._labels.includes('LovedOne')) return `üßë ${node.name}`;
  if (node._labels.includes('Community')) return `üè† ${node.name}`;
  return node.name || node.id || '';
    }

    function nodeColor(node) {
      if (!node._labels) return '#6fcf6f';
      if (node._labels.includes('User')) return '#4fa3ff';
      if (node._labels.includes('Applicant')) return '#f7c873';
      if (node._labels.includes('LovedOne')) return '#e74c3c';
      if (node._labels.includes('Community')) return '#b983ff';
      return '#6fcf6f';
    }

    function relLabel(rel) {
  if (rel.type === 'ASSIGNED_TO') return 'assigned to';
  if (rel.type === 'RELATED_TO') return rel.properties && rel.properties.relationship ? rel.properties.relationship : 'related to';
  return rel.type;
    }

    async function renderGraph() {
      console.log('[renderGraph] Starting graph render...');
      try {
        const data = await fetchGraph();
        console.log('[renderGraph] Data received:', data);
        if (!data) {
          document.getElementById('viz').innerHTML = '<div style="color:#e74c3c;padding:2em;text-align:center;">No data returned from server.</div>';
          return;
        }
        if (data.error) {
          document.getElementById('viz').innerHTML = `<div style="color:#e74c3c;padding:2em;text-align:center;">Error: ${data.error}${data.details ? '<br>Details: ' + data.details : ''}</div>`;
          return;
        }
        if (!data.nodes || !data.relationships) {
          console.log('[renderGraph] Missing nodes or relationships:', { hasNodes: !!data.nodes, hasRelationships: !!data.relationships });
          document.getElementById('viz').innerHTML = '<div style="color:#e74c3c;padding:2em;text-align:center;">No graph data found. Nodes: ' + (data.nodes?.length || 0) + ', Relationships: ' + (data.relationships?.length || 0) + '</div>';
          return;
        }
      const nodes = data.nodes.map(n => ({
        id: n._id,
        label: nodeLabel(n),
        color: nodeColor(n),
        shape: 'dot',
        size: 24,
        font: { color: '#fff', size: 16, face: 'Arial' },
        title: nodeLabel(n) // Tooltip on hover
      }));
      const edges = data.relationships.map(r => ({
        id: r.id,
        from: r.start,
        to: r.end,
        label: relLabel(r), // Show relationship labels on edges
        color: '#6fcf6f',
        font: { color: '#111', size: 14, align: 'middle', background: 'rgba(255,255,255,0.8)', strokeWidth: 2, strokeColor: '#000' },
        arrows: 'to',
        width: 2,
        title: relLabel(r) // Also show in tooltip
      }));
      const container = document.getElementById('viz');
      const networkData = { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) };
      const options = {
        nodes: { 
          borderWidth: 2,
          font: {
            color: '#fff',
            size: 16,
            face: 'Arial',
            align: 'center'
          },
          labelHighlightBold: true
        },
        edges: { 
          smooth: true,
          font: {
            size: 14,
            align: 'middle',
            color: '#111',
            background: 'rgba(255,255,255,0.8)',
            strokeWidth: 2,
            strokeColor: '#000'
          }
        },
        physics: {
          stabilization: { enabled: true, iterations: 100 },
          barnesHut: {
            springLength: 200,
            springConstant: 0.04
          }
        },
        layout: {
          hierarchical: {
            enabled: true,
            direction: 'UD',
            sortMethod: 'hubsize',
            nodeSpacing: 200,
            levelSeparation: 200
          },
          improvedLayout: false
        }
      };
      const network = new vis.Network(container, networkData, options);
      // Set initial zoom to 1.2x, centered
      network.once('afterDrawing', function() {
        network.moveTo({ scale: 1.2 });
      });
      // Disable physics after stabilization so nodes stay where placed
      network.once('stabilizationIterationsDone', function() {
        network.setOptions({ physics: false });
      });
      console.log('[renderGraph] Graph rendered successfully');
      } catch (err) {
        console.error('[renderGraph] Error rendering graph:', err);
        document.getElementById('viz').innerHTML = `<div style="color:#e74c3c;padding:2em;text-align:center;">Failed to render graph: ${err.message || err}</div>`;
      }
    }
    console.log('[graph.html] Calling renderGraph...');
    renderGraph();
  </script>
</body>
</html>
